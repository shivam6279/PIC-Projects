#include "BLDC.h"
#include "PWM.h"
#include <xc.h>
#include <stdbool.h>
#include <inttypes.h>
#include <sys/attribs.h>
#include <math.h>
#include "USART.h"
#include "SPI.h"
#include "ADC.h"
#include "pic32.h"
#include "PID.h"

#define _SQRT3_2 0.86602540378443864676372317075294
#define _1_SQRT3 0.57735026918962576450914878050196
#define _2_SQRT3 1.1547005383792515290182975610039

#define DEAD_TIME 25

float pole_pairs = POLE_PAIRS;
float foc_degree_advance = FOC_DEGREE_ADVANCE;

// SVPWM
float svpwm_max = 1000;
float SVPWM_table[LUT_SIZE] = {0.5, 0.5037787, 0.5075573999999999, 0.5113359, 0.5151142, 0.5188922, 0.5226699, 0.5264471, 0.5302239, 0.534, 0.5377755, 0.5415503, 0.5453243, 0.5490974, 0.5528696, 0.5566408, 0.5604108999999999, 0.5641798, 0.5679476, 0.571714, 0.5754791, 0.5792427, 0.5830049, 0.5867654, 0.5905243, 0.5942815, 0.5980369, 0.6017904, 0.6055419000000001, 0.6092915000000001, 0.613039, 0.6167843000000001, 0.6205274, 0.6242683, 0.6280067, 0.6317427, 0.6354761999999999, 0.6392070999999999, 0.6429353999999999, 0.6466609999999999, 0.6503837, 0.6541036, 0.6578206, 0.6615346, 0.6652454, 0.6689532, 0.6726577, 0.6763589, 0.6800567999999999, 0.6837513000000001, 0.6874422, 0.6911296, 0.6948133000000001, 0.6984933999999999, 0.7021696, 0.705842, 0.7095104999999999, 0.713175, 0.7168354, 0.7204918, 0.7241439000000001, 0.7277917, 0.7314352000000001, 0.7350743, 0.738709, 0.7423390000000001, 0.7459645, 0.7495853, 0.7532013, 0.7568125, 0.7604189, 0.7640202, 0.7676166, 0.7712078, 0.7747939, 0.7783747, 0.7819503, 0.7855205, 0.7890851999999999, 0.7926445, 0.7961980999999999, 0.7997462000000001, 0.8032885, 0.806825, 0.8103556999999999, 0.8138805, 0.8173994, 0.8209122, 0.8244188, 0.8279193, 0.8314136, 0.8349015000000001, 0.8383831, 0.8418582, 0.8453268, 0.8487889, 0.8522443, 0.855693, 0.8591349, 0.8625700000000001, 0.8659982, 0.8694194, 0.8728334999999999, 0.8762405999999999, 0.8796404999999999, 0.8830332, 0.8864186, 0.8897967, 0.8931673, 0.8965304, 0.899886, 0.9032340000000001, 0.9065742999999999, 0.9099069, 0.9132315999999999, 0.9165485, 0.9198573999999999, 0.9231584, 0.9264513, 0.9297361, 0.9330127, 0.9340993999999999, 0.9351778000000001, 0.9362480000000001, 0.9373098999999999, 0.9383634, 0.9394085999999999, 0.9404454, 0.9414738, 0.9424937999999999, 0.9435054, 0.9445086, 0.9455032999999999, 0.9464895, 0.9474672000000001, 0.9484364000000001, 0.949397, 0.9503491000000001, 0.9512926, 0.9522276000000001, 0.9531539, 0.9540716, 0.9549806, 0.955881, 0.9567727, 0.9576557, 0.95853, 0.9593955999999999, 0.9602524, 0.9611005, 0.9619398, 0.9627703, 0.9635919000000001, 0.9644048000000001, 0.9652088, 0.9660039, 0.9667902, 0.9675676, 0.9683361, 0.9690957, 0.9698463, 0.970588, 0.9713207, 0.9720445, 0.9727593000000001, 0.9734651, 0.9741618, 0.9748496, 0.9755282999999999, 0.9761979, 0.9768585000000001, 0.97751, 0.9781523999999999, 0.9787857, 0.9794098999999999, 0.9800249, 0.9806308, 0.9812276000000001, 0.9818152, 0.9823936999999999, 0.9829629, 0.983523, 0.9840738, 0.9846155, 0.9851479000000001, 0.9856710000000001, 0.986185, 0.9866896, 0.987185, 0.9876712, 0.988148, 0.9886155999999999, 0.9890738, 0.9895227, 0.9899624, 0.9903926000000001, 0.9908136, 0.9912251999999999, 0.9916275000000001, 0.9920203, 0.9924039, 0.992778, 0.9931428, 0.9934982, 0.9938442, 0.9941808, 0.9945079, 0.9948257, 0.995134, 0.9954329000000001, 0.9957224, 0.9960025, 0.9962731, 0.9965342, 0.9967859, 0.9970281999999999, 0.9972609, 0.9974843, 0.9976980999999999, 0.9979025, 0.9980973, 0.9982827999999999, 0.9984587, 0.9986250999999999, 0.9987820000000001, 0.9989294999999999, 0.9990674, 0.9991958, 0.9993148, 0.9994242000000001, 0.9995241, 0.9996145000000001, 0.9996953999999999, 0.9997668, 0.9998287, 0.999881, 0.9999238, 0.9999572, 0.999981, 0.9999952, 1.0, 0.9999952, 0.999981, 0.9999572, 0.9999238, 0.999881, 0.9998287, 0.9997668, 0.9996953999999999, 0.9996145000000001, 0.9995241, 0.9994242000000001, 0.9993148, 0.9991958, 0.9990674, 0.9989294999999999, 0.9987820000000001, 0.9986250999999999, 0.9984587, 0.9982827999999999, 0.9980973, 0.9979025, 0.9976980999999999, 0.9974843, 0.9972609, 0.9970281999999999, 0.9967859, 0.9965342, 0.9962731, 0.9960025, 0.9957224, 0.9954329000000001, 0.995134, 0.9948257, 0.9945079, 0.9941808, 0.9938442, 0.9934982, 0.9931428, 0.992778, 0.9924039, 0.9920203, 0.9916275000000001, 0.9912251999999999, 0.9908136, 0.9903926000000001, 0.9899624, 0.9895227, 0.9890738, 0.9886155999999999, 0.988148, 0.9876712, 0.987185, 0.9866896, 0.986185, 0.9856710000000001, 0.9851479000000001, 0.9846155, 0.9840738, 0.983523, 0.9829629, 0.9823936999999999, 0.9818152, 0.9812276000000001, 0.9806308, 0.9800249, 0.9794098999999999, 0.9787857, 0.9781523999999999, 0.97751, 0.9768585000000001, 0.9761979, 0.9755282999999999, 0.9748496, 0.9741618, 0.9734651, 0.9727593000000001, 0.9720445, 0.9713207, 0.970588, 0.9698463, 0.9690957, 0.9683361, 0.9675676, 0.9667902, 0.9660039, 0.9652088, 0.9644048000000001, 0.9635919000000001, 0.9627703, 0.9619398, 0.9611005, 0.9602524, 0.9593955999999999, 0.95853, 0.9576557, 0.9567727, 0.955881, 0.9549806, 0.9540716, 0.9531539, 0.9522276000000001, 0.9512926, 0.9503491000000001, 0.949397, 0.9484364000000001, 0.9474672000000001, 0.9464895, 0.9455032999999999, 0.9445086, 0.9435054, 0.9424937999999999, 0.9414738, 0.9404454, 0.9394085999999999, 0.9383634, 0.9373098999999999, 0.9362480000000001, 0.9351778000000001, 0.9340993999999999, 0.9330127, 0.9340993999999999, 0.9351778000000001, 0.9362480000000001, 0.9373098999999999, 0.9383634, 0.9394085999999999, 0.9404454, 0.9414738, 0.9424937999999999, 0.9435054, 0.9445086, 0.9455032999999999, 0.9464895, 0.9474672000000001, 0.9484364000000001, 0.949397, 0.9503491000000001, 0.9512926, 0.9522276000000001, 0.9531539, 0.9540716, 0.9549806, 0.955881, 0.9567727, 0.9576557, 0.95853, 0.9593955999999999, 0.9602524, 0.9611005, 0.9619398, 0.9627703, 0.9635919000000001, 0.9644048000000001, 0.9652088, 0.9660039, 0.9667902, 0.9675676, 0.9683361, 0.9690957, 0.9698463, 0.970588, 0.9713207, 0.9720445, 0.9727593000000001, 0.9734651, 0.9741618, 0.9748496, 0.9755282999999999, 0.9761979, 0.9768585000000001, 0.97751, 0.9781523999999999, 0.9787857, 0.9794098999999999, 0.9800249, 0.9806308, 0.9812276000000001, 0.9818152, 0.9823936999999999, 0.9829629, 0.983523, 0.9840738, 0.9846155, 0.9851479000000001, 0.9856710000000001, 0.986185, 0.9866896, 0.987185, 0.9876712, 0.988148, 0.9886155999999999, 0.9890738, 0.9895227, 0.9899624, 0.9903926000000001, 0.9908136, 0.9912251999999999, 0.9916275000000001, 0.9920203, 0.9924039, 0.992778, 0.9931428, 0.9934982, 0.9938442, 0.9941808, 0.9945079, 0.9948257, 0.995134, 0.9954329000000001, 0.9957224, 0.9960025, 0.9962731, 0.9965342, 0.9967859, 0.9970281999999999, 0.9972609, 0.9974843, 0.9976980999999999, 0.9979025, 0.9980973, 0.9982827999999999, 0.9984587, 0.9986250999999999, 0.9987820000000001, 0.9989294999999999, 0.9990674, 0.9991958, 0.9993148, 0.9994242000000001, 0.9995241, 0.9996145000000001, 0.9996953999999999, 0.9997668, 0.9998287, 0.999881, 0.9999238, 0.9999572, 0.999981, 0.9999952, 1.0, 0.9999952, 0.999981, 0.9999572, 0.9999238, 0.999881, 0.9998287, 0.9997668, 0.9996953999999999, 0.9996145000000001, 0.9995241, 0.9994242000000001, 0.9993148, 0.9991958, 0.9990674, 0.9989294999999999, 0.9987820000000001, 0.9986250999999999, 0.9984587, 0.9982827999999999, 0.9980973, 0.9979025, 0.9976980999999999, 0.9974843, 0.9972609, 0.9970281999999999, 0.9967859, 0.9965342, 0.9962731, 0.9960025, 0.9957224, 0.9954329000000001, 0.995134, 0.9948257, 0.9945079, 0.9941808, 0.9938442, 0.9934982, 0.9931428, 0.992778, 0.9924039, 0.9920203, 0.9916275000000001, 0.9912251999999999, 0.9908136, 0.9903926000000001, 0.9899624, 0.9895227, 0.9890738, 0.9886155999999999, 0.988148, 0.9876712, 0.987185, 0.9866896, 0.986185, 0.9856710000000001, 0.9851479000000001, 0.9846155, 0.9840738, 0.983523, 0.9829629, 0.9823936999999999, 0.9818152, 0.9812276000000001, 0.9806308, 0.9800249, 0.9794098999999999, 0.9787857, 0.9781523999999999, 0.97751, 0.9768585000000001, 0.9761979, 0.9755282999999999, 0.9748496, 0.9741618, 0.9734651, 0.9727593000000001, 0.9720445, 0.9713207, 0.970588, 0.9698463, 0.9690957, 0.9683361, 0.9675676, 0.9667902, 0.9660039, 0.9652088, 0.9644048000000001, 0.9635919000000001, 0.9627703, 0.9619398, 0.9611005, 0.9602524, 0.9593955999999999, 0.95853, 0.9576557, 0.9567727, 0.955881, 0.9549806, 0.9540716, 0.9531539, 0.9522276000000001, 0.9512926, 0.9503491000000001, 0.949397, 0.9484364000000001, 0.9474672000000001, 0.9464895, 0.9455032999999999, 0.9445086, 0.9435054, 0.9424937999999999, 0.9414738, 0.9404454, 0.9394085999999999, 0.9383634, 0.9373098999999999, 0.9362480000000001, 0.9351778000000001, 0.9340993999999999, 0.9330127, 0.9297361, 0.9264513, 0.9231584, 0.9198573999999999, 0.9165485, 0.9132315999999999, 0.9099069, 0.9065742999999999, 0.9032340000000001, 0.899886, 0.8965304, 0.8931673, 0.8897967, 0.8864186, 0.8830332, 0.8796404999999999, 0.8762405999999999, 0.8728334999999999, 0.8694194, 0.8659982, 0.8625700000000001, 0.8591349, 0.855693, 0.8522443, 0.8487889, 0.8453268, 0.8418582, 0.8383831, 0.8349015000000001, 0.8314136, 0.8279193, 0.8244188, 0.8209122, 0.8173994, 0.8138805, 0.8103556999999999, 0.806825, 0.8032885, 0.7997462000000001, 0.7961980999999999, 0.7926445, 0.7890851999999999, 0.7855205, 0.7819503, 0.7783747, 0.7747939, 0.7712078, 0.7676166, 0.7640202, 0.7604189, 0.7568125, 0.7532013, 0.7495853, 0.7459645, 0.7423390000000001, 0.738709, 0.7350743, 0.7314352000000001, 0.7277917, 0.7241439000000001, 0.7204918, 0.7168354, 0.713175, 0.7095104999999999, 0.705842, 0.7021696, 0.6984933999999999, 0.6948133000000001, 0.6911296, 0.6874422, 0.6837513000000001, 0.6800567999999999, 0.6763589, 0.6726577, 0.6689532, 0.6652454, 0.6615346, 0.6578206, 0.6541036, 0.6503837, 0.6466609999999999, 0.6429353999999999, 0.6392070999999999, 0.6354761999999999, 0.6317427, 0.6280067, 0.6242683, 0.6205274, 0.6167843000000001, 0.613039, 0.6092915000000001, 0.6055419000000001, 0.6017904, 0.5980369, 0.5942815, 0.5905243, 0.5867654, 0.5830049, 0.5792427, 0.5754791, 0.571714, 0.5679476, 0.5641798, 0.5604108999999999, 0.5566408, 0.5528696, 0.5490974, 0.5453243, 0.5415503, 0.5377755, 0.534, 0.5302239, 0.5264471, 0.5226699, 0.5188922, 0.5151142, 0.5113359, 0.5075573999999999, 0.5037787, 0.5, 0.4962213, 0.4924426, 0.48866410000000005, 0.48488580000000003, 0.4811078, 0.47733010000000003, 0.4735529, 0.4697761, 0.466, 0.4622245, 0.4584497, 0.4546757, 0.4509026, 0.4471304, 0.4433592, 0.43958909999999995, 0.4358202, 0.4320524, 0.428286, 0.4245209, 0.4207573, 0.41699509999999995, 0.4132346, 0.4094757, 0.4057185, 0.4019631, 0.3982096, 0.3944581, 0.3907085, 0.386961, 0.38321570000000005, 0.3794726, 0.3757317, 0.37199329999999997, 0.3682573, 0.3645238, 0.36079289999999997, 0.3570646, 0.353339, 0.34961630000000005, 0.34589640000000005, 0.34217939999999997, 0.33846539999999997, 0.33475459999999996, 0.33104680000000003, 0.32734230000000003, 0.3236411, 0.3199432, 0.3162487, 0.3125578, 0.30887040000000004, 0.3051867, 0.3015066, 0.2978304, 0.29415800000000003, 0.2904895, 0.286825, 0.2831646, 0.2795082, 0.27585610000000005, 0.2722083, 0.2685648, 0.2649257, 0.261291, 0.25766100000000003, 0.2540355, 0.2504147, 0.2467987, 0.2431875, 0.2395811, 0.23597980000000002, 0.2323834, 0.2287922, 0.2252061, 0.2216253, 0.2180497, 0.2144795, 0.2109148, 0.2073555, 0.20380189999999998, 0.2002538, 0.1967115, 0.193175, 0.1896443, 0.1861195, 0.18260059999999997, 0.1790878, 0.1755812, 0.1720807, 0.1685864, 0.1650985, 0.16161689999999998, 0.1581418, 0.1546732, 0.1512111, 0.1477557, 0.144307, 0.14086510000000002, 0.13743, 0.1340018, 0.1305806, 0.1271665, 0.1237594, 0.1203595, 0.11696680000000001, 0.1135814, 0.1102033, 0.1068327, 0.1034696, 0.10011400000000001, 0.096766, 0.0934257, 0.09009310000000001, 0.0867684, 0.0834515, 0.08014260000000001, 0.0768416, 0.0735487, 0.0702639, 0.0669873, 0.0659006, 0.0648222, 0.063752, 0.0626901, 0.0616366, 0.060591400000000004, 0.0595546, 0.0585262, 0.0575062, 0.0564946, 0.055491399999999996, 0.054496699999999995, 0.0535105, 0.052532800000000004, 0.0515636, 0.050603, 0.0496509, 0.0487074, 0.0477724, 0.0468461, 0.0459284, 0.045019399999999994, 0.044119, 0.043227299999999996, 0.042344299999999994, 0.04147, 0.0406044, 0.0397476, 0.038899500000000004, 0.0380602, 0.037229700000000004, 0.0364081, 0.0355952, 0.0347912, 0.0339961, 0.033209800000000005, 0.0324324, 0.0316639, 0.0309043, 0.030153700000000002, 0.029412, 0.0286793, 0.0279555, 0.0272407, 0.0265349, 0.025838200000000002, 0.0251504, 0.0244717, 0.0238021, 0.023141500000000002, 0.02249, 0.0218476, 0.021214300000000002, 0.0205901, 0.019975100000000003, 0.0193692, 0.0187724, 0.018184799999999997, 0.017606300000000002, 0.0170371, 0.016477, 0.015926199999999998, 0.015384499999999999, 0.0148521, 0.014329000000000001, 0.013815, 0.0133104, 0.012815, 0.0123288, 0.011852, 0.0113844, 0.0109262, 0.0104773, 0.010037599999999999, 0.0096074, 0.0091864, 0.008774800000000001, 0.0083725, 0.007979700000000001, 0.0075961, 0.007222, 0.0068572, 0.0065018, 0.0061558, 0.0058192, 0.0054921, 0.0051743, 0.004866, 0.0045671, 0.0042775999999999995, 0.0039975, 0.0037269, 0.0034658000000000002, 0.0032141, 0.0029718, 0.0027391, 0.0025156999999999996, 0.0023019, 0.0020975, 0.0019027, 0.0017172, 0.0015412999999999998, 0.0013749, 0.001218, 0.0010705, 0.0009326, 0.0008042, 0.0006852000000000001, 0.0005758, 0.00047589999999999997, 0.0003855, 0.0003046, 0.0002332, 0.00017130000000000002, 0.00011899999999999999, 7.620000000000001e-05, 4.28e-05, 1.9e-05, 4.8e-06, 0.0, 4.8e-06, 1.9e-05, 4.28e-05, 7.620000000000001e-05, 0.00011899999999999999, 0.00017130000000000002, 0.0002332, 0.0003046, 0.0003855, 0.00047589999999999997, 0.0005758, 0.0006852000000000001, 0.0008042, 0.0009326, 0.0010705, 0.001218, 0.0013749, 0.0015412999999999998, 0.0017172, 0.0019027, 0.0020975, 0.0023019, 0.0025156999999999996, 0.0027391, 0.0029718, 0.0032141, 0.0034658000000000002, 0.0037269, 0.0039975, 0.0042775999999999995, 0.0045671, 0.004866, 0.0051743, 0.0054921, 0.0058192, 0.0061558, 0.0065018, 0.0068572, 0.007222, 0.0075961, 0.007979700000000001, 0.0083725, 0.008774800000000001, 0.0091864, 0.0096074, 0.010037599999999999, 0.0104773, 0.0109262, 0.0113844, 0.011852, 0.0123288, 0.012815, 0.0133104, 0.013815, 0.014329000000000001, 0.0148521, 0.015384499999999999, 0.015926199999999998, 0.016477, 0.0170371, 0.017606300000000002, 0.018184799999999997, 0.0187724, 0.0193692, 0.019975100000000003, 0.0205901, 0.021214300000000002, 0.0218476, 0.02249, 0.023141500000000002, 0.0238021, 0.0244717, 0.0251504, 0.025838200000000002, 0.0265349, 0.0272407, 0.0279555, 0.0286793, 0.029412, 0.030153700000000002, 0.0309043, 0.0316639, 0.0324324, 0.033209800000000005, 0.0339961, 0.0347912, 0.0355952, 0.0364081, 0.037229700000000004, 0.0380602, 0.038899500000000004, 0.0397476, 0.0406044, 0.04147, 0.042344299999999994, 0.043227299999999996, 0.044119, 0.045019399999999994, 0.0459284, 0.0468461, 0.0477724, 0.0487074, 0.0496509, 0.050603, 0.0515636, 0.052532800000000004, 0.0535105, 0.054496699999999995, 0.055491399999999996, 0.0564946, 0.0575062, 0.0585262, 0.0595546, 0.060591400000000004, 0.0616366, 0.0626901, 0.063752, 0.0648222, 0.0659006, 0.0669873, 0.0659006, 0.0648222, 0.063752, 0.0626901, 0.0616366, 0.060591400000000004, 0.0595546, 0.0585262, 0.0575062, 0.0564946, 0.055491399999999996, 0.054496699999999995, 0.0535105, 0.052532800000000004, 0.0515636, 0.050603, 0.0496509, 0.0487074, 0.0477724, 0.0468461, 0.0459284, 0.045019399999999994, 0.044119, 0.043227299999999996, 0.042344299999999994, 0.04147, 0.0406044, 0.0397476, 0.038899500000000004, 0.0380602, 0.037229700000000004, 0.0364081, 0.0355952, 0.0347912, 0.0339961, 0.033209800000000005, 0.0324324, 0.0316639, 0.0309043, 0.030153700000000002, 0.029412, 0.0286793, 0.0279555, 0.0272407, 0.0265349, 0.025838200000000002, 0.0251504, 0.0244717, 0.0238021, 0.023141500000000002, 0.02249, 0.0218476, 0.021214300000000002, 0.0205901, 0.019975100000000003, 0.0193692, 0.0187724, 0.018184799999999997, 0.017606300000000002, 0.0170371, 0.016477, 0.015926199999999998, 0.015384499999999999, 0.0148521, 0.014329000000000001, 0.013815, 0.0133104, 0.012815, 0.0123288, 0.011852, 0.0113844, 0.0109262, 0.0104773, 0.010037599999999999, 0.0096074, 0.0091864, 0.008774800000000001, 0.0083725, 0.007979700000000001, 0.0075961, 0.007222, 0.0068572, 0.0065018, 0.0061558, 0.0058192, 0.0054921, 0.0051743, 0.004866, 0.0045671, 0.0042775999999999995, 0.0039975, 0.0037269, 0.0034658000000000002, 0.0032141, 0.0029718, 0.0027391, 0.0025156999999999996, 0.0023019, 0.0020975, 0.0019027, 0.0017172, 0.0015412999999999998, 0.0013749, 0.001218, 0.0010705, 0.0009326, 0.0008042, 0.0006852000000000001, 0.0005758, 0.00047589999999999997, 0.0003855, 0.0003046, 0.0002332, 0.00017130000000000002, 0.00011899999999999999, 7.620000000000001e-05, 4.28e-05, 1.9e-05, 4.8e-06, 0.0, 4.8e-06, 1.9e-05, 4.28e-05, 7.620000000000001e-05, 0.00011899999999999999, 0.00017130000000000002, 0.0002332, 0.0003046, 0.0003855, 0.00047589999999999997, 0.0005758, 0.0006852000000000001, 0.0008042, 0.0009326, 0.0010705, 0.001218, 0.0013749, 0.0015412999999999998, 0.0017172, 0.0019027, 0.0020975, 0.0023019, 0.0025156999999999996, 0.0027391, 0.0029718, 0.0032141, 0.0034658000000000002, 0.0037269, 0.0039975, 0.0042775999999999995, 0.0045671, 0.004866, 0.0051743, 0.0054921, 0.0058192, 0.0061558, 0.0065018, 0.0068572, 0.007222, 0.0075961, 0.007979700000000001, 0.0083725, 0.008774800000000001, 0.0091864, 0.0096074, 0.010037599999999999, 0.0104773, 0.0109262, 0.0113844, 0.011852, 0.0123288, 0.012815, 0.0133104, 0.013815, 0.014329000000000001, 0.0148521, 0.015384499999999999, 0.015926199999999998, 0.016477, 0.0170371, 0.017606300000000002, 0.018184799999999997, 0.0187724, 0.0193692, 0.019975100000000003, 0.0205901, 0.021214300000000002, 0.0218476, 0.02249, 0.023141500000000002, 0.0238021, 0.0244717, 0.0251504, 0.025838200000000002, 0.0265349, 0.0272407, 0.0279555, 0.0286793, 0.029412, 0.030153700000000002, 0.0309043, 0.0316639, 0.0324324, 0.033209800000000005, 0.0339961, 0.0347912, 0.0355952, 0.0364081, 0.037229700000000004, 0.0380602, 0.038899500000000004, 0.0397476, 0.0406044, 0.04147, 0.042344299999999994, 0.043227299999999996, 0.044119, 0.045019399999999994, 0.0459284, 0.0468461, 0.0477724, 0.0487074, 0.0496509, 0.050603, 0.0515636, 0.052532800000000004, 0.0535105, 0.054496699999999995, 0.055491399999999996, 0.0564946, 0.0575062, 0.0585262, 0.0595546, 0.060591400000000004, 0.0616366, 0.0626901, 0.063752, 0.0648222, 0.0659006, 0.0669873, 0.0702639, 0.0735487, 0.0768416, 0.08014260000000001, 0.0834515, 0.0867684, 0.09009310000000001, 0.0934257, 0.096766, 0.10011400000000001, 0.1034696, 0.1068327, 0.1102033, 0.1135814, 0.11696680000000001, 0.1203595, 0.1237594, 0.1271665, 0.1305806, 0.1340018, 0.13743, 0.14086510000000002, 0.144307, 0.1477557, 0.1512111, 0.1546732, 0.1581418, 0.16161689999999998, 0.1650985, 0.1685864, 0.1720807, 0.1755812, 0.1790878, 0.18260059999999997, 0.1861195, 0.1896443, 0.193175, 0.1967115, 0.2002538, 0.20380189999999998, 0.2073555, 0.2109148, 0.2144795, 0.2180497, 0.2216253, 0.2252061, 0.2287922, 0.2323834, 0.23597980000000002, 0.2395811, 0.2431875, 0.2467987, 0.2504147, 0.2540355, 0.25766100000000003, 0.261291, 0.2649257, 0.2685648, 0.2722083, 0.27585610000000005, 0.2795082, 0.2831646, 0.286825, 0.2904895, 0.29415800000000003, 0.2978304, 0.3015066, 0.3051867, 0.30887040000000004, 0.3125578, 0.3162487, 0.3199432, 0.3236411, 0.32734230000000003, 0.33104680000000003, 0.33475459999999996, 0.33846539999999997, 0.34217939999999997, 0.34589640000000005, 0.34961630000000005, 0.353339, 0.3570646, 0.36079289999999997, 0.3645238, 0.3682573, 0.37199329999999997, 0.3757317, 0.3794726, 0.38321570000000005, 0.386961, 0.3907085, 0.3944581, 0.3982096, 0.4019631, 0.4057185, 0.4094757, 0.4132346, 0.41699509999999995, 0.4207573, 0.4245209, 0.428286, 0.4320524, 0.4358202, 0.43958909999999995, 0.4433592, 0.4471304, 0.4509026, 0.4546757, 0.4584497, 0.4622245, 0.466, 0.4697761, 0.4735529, 0.47733010000000003, 0.4811078, 0.48488580000000003, 0.48866410000000005, 0.4924426, 0.4962213};
float SIN_table[LUT_SIZE] = {500, 502.1816546, 504.3632677, 506.5447978, 508.7262032, 510.9074425, 513.0884742, 515.2692566, 517.4497484, 519.6299079, 521.8096937, 523.9890643, 526.1679781, 528.3463938, 530.5242698, 532.7015646, 534.8782369, 537.0542451, 539.2295479, 541.4041038, 543.5778714, 545.7508093, 547.9228763, 550.0940308, 552.2642316, 554.4334374, 556.6016069, 558.7686987, 560.9346717, 563.0994846, 565.2630961, 567.4254651, 569.5865505, 571.746311, 573.9047056, 576.0616931, 578.2172325, 580.3712828, 582.5238029, 584.6747519, 586.8240888, 588.9717727, 591.1177627, 593.262018, 595.4044977, 597.545161, 599.6839672, 601.8208756, 603.9558454, 606.0888361, 608.219807, 610.3487175, 612.4755272, 614.6001955, 616.7226819, 618.8429462, 620.9609478, 623.0766465, 625.190002, 627.3009741, 629.4095226, 631.5156072, 633.619188, 635.7202249, 637.8186779, 639.914507, 642.0076724, 644.0981341, 646.1858524, 648.2707875, 650.3528998, 652.4321495, 654.5084972, 656.5819032, 658.6523282, 660.7197327, 662.7840772, 664.8453226, 666.9034296, 668.958359, 671.0100717, 673.0585285, 675.1036906, 677.145519, 679.1839748, 681.2190191, 683.2506134, 685.2787188, 687.3032967, 689.3243087, 691.3417162, 693.3554808, 695.3655642, 697.3719282, 699.3745345, 701.3733449, 703.3683215, 705.3594263, 707.3466213, 709.3298688, 711.3091309, 713.28437, 715.2555484, 717.2226287, 719.1855734, 721.1443451, 723.0989066, 725.0492205, 726.9952499, 728.9369576, 730.8743066, 732.8072602, 734.7357814, 736.6598336, 738.5793801, 740.4943845, 742.4048101, 744.3106207, 746.2117801, 748.1082518, 750, 751.8869885, 753.7691815, 755.646543, 757.5190375, 759.3866291, 761.2492824, 763.1069618, 764.9596321, 766.807258, 768.6498042, 770.4872357, 772.3195175, 774.1466148, 775.9684927, 777.7851165, 779.5964517, 781.4024638, 783.2031185, 784.9983813, 786.7882182, 788.572595, 790.3514779, 792.1248328, 793.8926261, 795.6548242, 797.4113934, 799.1623003, 800.9075116, 802.646994, 804.3807145, 806.10864, 807.8307377, 809.5469747, 811.2573183, 812.9617361, 814.6601955, 816.3526643, 818.0391101, 819.719501, 821.3938048, 823.0619898, 824.7240242, 826.3798762, 828.0295145, 829.6729076, 831.3100241, 832.940833, 834.5653032, 836.1834037, 837.7951038, 839.4003728, 840.99918, 842.5914952, 844.1772878, 845.7565279, 847.3291852, 848.8952299, 850.4546321, 852.0073622, 853.5533906, 855.0926878, 856.6252246, 858.1509717, 859.6699002, 861.181981, 862.6871855, 864.1854849, 865.6768508, 867.1612547, 868.6386684, 870.1090637, 871.5724127, 873.0286875, 874.4778604, 875.9199037, 877.3547901, 878.7824922, 880.2029828, 881.6162349, 883.0222216, 884.420916, 885.8122917, 887.196322, 888.5729807, 889.9422415, 891.3040784, 892.6584654, 894.0053768, 895.3447869, 896.6766701, 898.0010013, 899.317755, 900.6269063, 901.9284303, 903.2223021, 904.5084972, 905.786991, 907.0577592, 908.3207776, 909.5760221, 910.823469, 912.0630943, 913.2948746, 914.5187863, 915.7348062, 916.942911, 918.1430779, 919.335284, 920.5195065, 921.6957229, 922.8639109, 924.0240481, 925.1761125, 926.3200822, 927.4559353, 928.5836504, 929.7032058, 930.8145802, 931.9177526, 933.0127019, 934.0994072, 935.177848, 936.2480035, 937.3098536, 938.3633779, 939.4085563, 940.4453691, 941.4737964, 942.4938187, 943.5054166, 944.5085707, 945.5032621, 946.4894717, 947.4671808, 948.4363708, 949.3970231, 950.3491197, 951.2926422, 952.2275727, 953.1538935, 954.0715869, 954.9806354, 955.8810218, 956.7727288, 957.6557396, 958.5300372, 959.3956051, 960.2524267, 961.1004858, 961.9397663, 962.770252, 963.5919273, 964.4047764, 965.208784, 966.0039346, 966.7902132, 967.5676048, 968.3360946, 969.095668, 969.8463104, 970.5880076, 971.3207455, 972.0445102, 972.7592878, 973.4650647, 974.1618276, 974.8495631, 975.5282581, 976.1978998, 976.8584754, 977.5099722, 978.152378, 978.7856804, 979.4098674, 980.0249272, 980.630848, 981.2276182, 981.8152266, 982.3936619, 982.9629131, 983.5229695, 984.0738202, 984.6154549, 985.1478631, 985.6710349, 986.1849602, 986.6896292, 987.1850324, 987.6711603, 988.1480036, 988.6155532, 989.0738004, 989.5227362, 989.9623523, 990.3926402, 990.8135917, 991.2251989, 991.6274538, 992.0203488, 992.4038765, 992.7780295, 993.1428008, 993.4981833, 993.8441703, 994.1807552, 994.5079317, 994.8256934, 995.1340344, 995.4329487, 995.7224307, 996.0024748, 996.2730758, 996.5342285, 996.7859278, 997.0281691, 997.2609477, 997.4842591, 997.6980992, 997.9024638, 998.097349, 998.2827512, 998.4586669, 998.6250925, 998.7820251, 998.9294616, 999.0673992, 999.1958353, 999.3147674, 999.4241932, 999.5241108, 999.6145181, 999.6954135, 999.7667954, 999.8286625, 999.8810135, 999.9238476, 999.9571638, 999.9809615, 999.9952404, 1000, 999.9952404, 999.9809615, 999.9571638, 999.9238476, 999.8810135, 999.8286625, 999.7667954, 999.6954135, 999.6145181, 999.5241108, 999.4241932, 999.3147674, 999.1958353, 999.0673992, 998.9294616, 998.7820251, 998.6250925, 998.4586669, 998.2827512, 998.097349, 997.9024638, 997.6980992, 997.4842591, 997.2609477, 997.0281691, 996.7859278, 996.5342285, 996.2730758, 996.0024748, 995.7224307, 995.4329487, 995.1340344, 994.8256934, 994.5079317, 994.1807552, 993.8441703, 993.4981833, 993.1428008, 992.7780295, 992.4038765, 992.0203488, 991.6274538, 991.2251989, 990.8135917, 990.3926402, 989.9623523, 989.5227362, 989.0738004, 988.6155532, 988.1480036, 987.6711603, 987.1850324, 986.6896292, 986.1849602, 985.6710349, 985.1478631, 984.6154549, 984.0738202, 983.5229695, 982.9629131, 982.3936619, 981.8152266, 981.2276182, 980.630848, 980.0249272, 979.4098674, 978.7856804, 978.152378, 977.5099722, 976.8584754, 976.1978998, 975.5282581, 974.8495631, 974.1618276, 973.4650647, 972.7592878, 972.0445102, 971.3207455, 970.5880076, 969.8463104, 969.095668, 968.3360946, 967.5676048, 966.7902132, 966.0039346, 965.208784, 964.4047764, 963.5919273, 962.770252, 961.9397663, 961.1004858, 960.2524267, 959.3956051, 958.5300372, 957.6557396, 956.7727288, 955.8810218, 954.9806354, 954.0715869, 953.1538935, 952.2275727, 951.2926422, 950.3491197, 949.3970231, 948.4363708, 947.4671808, 946.4894717, 945.5032621, 944.5085707, 943.5054166, 942.4938187, 941.4737964, 940.4453691, 939.4085563, 938.3633779, 937.3098536, 936.2480035, 935.177848, 934.0994072, 933.0127019, 931.9177526, 930.8145802, 929.7032058, 928.5836504, 927.4559353, 926.3200822, 925.1761125, 924.0240481, 922.8639109, 921.6957229, 920.5195065, 919.335284, 918.1430779, 916.942911, 915.7348062, 914.5187863, 913.2948746, 912.0630943, 910.823469, 909.5760221, 908.3207776, 907.0577592, 905.786991, 904.5084972, 903.2223021, 901.9284303, 900.6269063, 899.317755, 898.0010013, 896.6766701, 895.3447869, 894.0053768, 892.6584654, 891.3040784, 889.9422415, 888.5729807, 887.196322, 885.8122917, 884.420916, 883.0222216, 881.6162349, 880.2029828, 878.7824922, 877.3547901, 875.9199037, 874.4778604, 873.0286875, 871.5724127, 870.1090637, 868.6386684, 867.1612547, 865.6768508, 864.1854849, 862.6871855, 861.181981, 859.6699002, 858.1509717, 856.6252246, 855.0926878, 853.5533906, 852.0073622, 850.4546321, 848.8952299, 847.3291852, 845.7565279, 844.1772878, 842.5914952, 840.99918, 839.4003728, 837.7951038, 836.1834037, 834.5653032, 832.940833, 831.3100241, 829.6729076, 828.0295145, 826.3798762, 824.7240242, 823.0619898, 821.3938048, 819.719501, 818.0391101, 816.3526643, 814.6601955, 812.9617361, 811.2573183, 809.5469747, 807.8307377, 806.10864, 804.3807145, 802.646994, 800.9075116, 799.1623003, 797.4113934, 795.6548242, 793.8926261, 792.1248328, 790.3514779, 788.572595, 786.7882182, 784.9983813, 783.2031185, 781.4024638, 779.5964517, 777.7851165, 775.9684927, 774.1466148, 772.3195175, 770.4872357, 768.6498042, 766.807258, 764.9596321, 763.1069618, 761.2492824, 759.3866291, 757.5190375, 755.646543, 753.7691815, 751.8869885, 750, 748.1082518, 746.2117801, 744.3106207, 742.4048101, 740.4943845, 738.5793801, 736.6598336, 734.7357814, 732.8072602, 730.8743066, 728.9369576, 726.9952499, 725.0492205, 723.0989066, 721.1443451, 719.1855734, 717.2226287, 715.2555484, 713.28437, 711.3091309, 709.3298688, 707.3466213, 705.3594263, 703.3683215, 701.3733449, 699.3745345, 697.3719282, 695.3655642, 693.3554808, 691.3417162, 689.3243087, 687.3032967, 685.2787188, 683.2506134, 681.2190191, 679.1839748, 677.145519, 675.1036906, 673.0585285, 671.0100717, 668.958359, 666.9034296, 664.8453226, 662.7840772, 660.7197327, 658.6523282, 656.5819032, 654.5084972, 652.4321495, 650.3528998, 648.2707875, 646.1858524, 644.0981341, 642.0076724, 639.914507, 637.8186779, 635.7202249, 633.619188, 631.5156072, 629.4095226, 627.3009741, 625.190002, 623.0766465, 620.9609478, 618.8429462, 616.7226819, 614.6001955, 612.4755272, 610.3487175, 608.219807, 606.0888361, 603.9558454, 601.8208756, 599.6839672, 597.545161, 595.4044977, 593.262018, 591.1177627, 588.9717727, 586.8240888, 584.6747519, 582.5238029, 580.3712828, 578.2172325, 576.0616931, 573.9047056, 571.746311, 569.5865505, 567.4254651, 565.2630961, 563.0994846, 560.9346717, 558.7686987, 556.6016069, 554.4334374, 552.2642316, 550.0940308, 547.9228763, 545.7508093, 543.5778714, 541.4041038, 539.2295479, 537.0542451, 534.8782369, 532.7015646, 530.5242698, 528.3463938, 526.1679781, 523.9890643, 521.8096937, 519.6299079, 517.4497484, 515.2692566, 513.0884742, 510.9074425, 508.7262032, 506.5447978, 504.3632677, 502.1816546, 500, 497.8183454, 495.6367323, 493.4552022, 491.2737968, 489.0925575, 486.9115258, 484.7307434, 482.5502516, 480.3700921, 478.1903063, 476.0109357, 473.8320219, 471.6536062, 469.4757302, 467.2984354, 465.1217631, 462.9457549, 460.7704521, 458.5958962, 456.4221286, 454.2491907, 452.0771237, 449.9059692, 447.7357684, 445.5665626, 443.3983931, 441.2313013, 439.0653283, 436.9005154, 434.7369039, 432.5745349, 430.4134495, 428.253689, 426.0952944, 423.9383069, 421.7827675, 419.6287172, 417.4761971, 415.3252481, 413.1759112, 411.0282273, 408.8822373, 406.737982, 404.5955023, 402.454839, 400.3160328, 398.1791244, 396.0441546, 393.9111639, 391.780193, 389.6512825, 387.5244728, 385.3998045, 383.2773181, 381.1570538, 379.0390522, 376.9233535, 374.809998, 372.6990259, 370.5904774, 368.4843928, 366.380812, 364.2797751, 362.1813221, 360.085493, 357.9923276, 355.9018659, 353.8141476, 351.7292125, 349.6471002, 347.5678505, 345.4915028, 343.4180968, 341.3476718, 339.2802673, 337.2159228, 335.1546774, 333.0965704, 331.041641, 328.9899283, 326.9414715, 324.8963094, 322.854481, 320.8160252, 318.7809809, 316.7493866, 314.7212812, 312.6967033, 310.6756913, 308.6582838, 306.6445192, 304.6344358, 302.6280718, 300.6254655, 298.6266551, 296.6316785, 294.6405737, 292.6533787, 290.6701312, 288.6908691, 286.71563, 284.7444516, 282.7773713, 280.8144266, 278.8556549, 276.9010934, 274.9507795, 273.0047501, 271.0630424, 269.1256934, 267.1927398, 265.2642186, 263.3401664, 261.4206199, 259.5056155, 257.5951899, 255.6893793, 253.7882199, 251.8917482, 250, 248.1130115, 246.2308185, 244.353457, 242.4809625, 240.6133709, 238.7507176, 236.8930382, 235.0403679, 233.192742, 231.3501958, 229.5127643, 227.6804825, 225.8533852, 224.0315073, 222.2148835, 220.4035483, 218.5975362, 216.7968815, 215.0016187, 213.2117818, 211.427405, 209.6485221, 207.8751672, 206.1073739, 204.3451758, 202.5886066, 200.8376997, 199.0924884, 197.353006, 195.6192855, 193.89136, 192.1692623, 190.4530253, 188.7426817, 187.0382639, 185.3398045, 183.6473357, 181.9608899, 180.280499, 178.6061952, 176.9380102, 175.2759758, 173.6201238, 171.9704855, 170.3270924, 168.6899759, 167.059167, 165.4346968, 163.8165963, 162.2048962, 160.5996272, 159.00082, 157.4085048, 155.8227122, 154.2434721, 152.6708148, 151.1047701, 149.5453679, 147.9926378, 146.4466094, 144.9073122, 143.3747754, 141.8490283, 140.3300998, 138.818019, 137.3128145, 135.8145151, 134.3231492, 132.8387453, 131.3613316, 129.8909363, 128.4275873, 126.9713125, 125.5221396, 124.0800963, 122.6452099, 121.2175078, 119.7970172, 118.3837651, 116.9777784, 115.579084, 114.1877083, 112.803678, 111.4270193, 110.0577585, 108.6959216, 107.3415346, 105.9946232, 104.6552131, 103.3233299, 101.9989987, 100.682245, 99.37309365, 98.07156969, 96.77769787, 95.49150281, 94.21300902, 92.94224082, 91.67922242, 90.42397786, 89.17653103, 87.93690569, 86.70512544, 85.48121372, 84.26519385, 83.05708897, 81.85692208, 80.66471603, 79.48049352, 78.30427709, 77.13608915, 75.97595192, 74.8238875, 73.67991782, 72.54406466, 71.41634965, 70.29679425, 69.18541978, 68.0822474, 66.98729811, 65.90059276, 64.82215203, 63.75199646, 62.69014643, 61.63662215, 60.59144367, 59.5546309, 58.52620357, 57.50618127, 56.49458341, 55.49142926, 54.49673791, 53.51052829, 52.5328192, 51.56362923, 50.60297685, 49.65088034, 48.70735783, 47.77242727, 46.84610648, 45.92841309, 45.01936456, 44.11897821, 43.22727118, 42.34426044, 41.46996281, 40.60439493, 39.74757327, 38.89951416, 38.06023374, 37.22974799, 36.40807272, 35.59522356, 34.79121601, 33.99606536, 33.20978675, 32.43239516, 31.66390538, 30.90433204, 30.15368961, 29.41199237, 28.67925445, 27.9554898, 27.2407122, 26.53493525, 25.8381724, 25.1504369, 24.47174185, 23.80210018, 23.14152463, 22.49002777, 21.84762202, 21.2143196, 20.59013257, 19.97507281, 19.36915203, 18.77238177, 18.1847734, 17.60633809, 17.03708686, 16.47703054, 15.92617981, 15.38454515, 14.85213686, 14.32896509, 13.8150398, 13.31037077, 12.81496761, 12.32883975, 11.85199644, 11.38444677, 10.92619963, 10.47726376, 10.03764769, 9.607359798, 9.186408276, 8.774801137, 8.372546218, 7.979651177, 7.596123494, 7.221970471, 6.857199231, 6.50181672, 6.155829702, 5.819244766, 5.492068319, 5.17430659, 4.865965629, 4.567051307, 4.277569313, 3.99752516, 3.726924179, 3.465771523, 3.214072162, 2.971830889, 2.739052316, 2.515740875, 2.301900816, 2.097536213, 1.902650954, 1.717248751, 1.541333133, 1.37490745, 1.21797487, 1.070538381, 0.932600789, 0.804164721, 0.685232623, 0.575806758, 0.475889209, 0.38548188, 0.30458649, 0.233204582, 0.171337512, 0.11898646, 0.076152422, 0.042836213, 0.019038468, 0.00475964, 0, 0.00475964, 0.019038468, 0.042836213, 0.076152422, 0.11898646, 0.171337512, 0.233204582, 0.30458649, 0.38548188, 0.475889209, 0.575806758, 0.685232623, 0.804164721, 0.932600789, 1.070538381, 1.21797487, 1.37490745, 1.541333133, 1.717248751, 1.902650954, 2.097536213, 2.301900816, 2.515740875, 2.739052316, 2.971830889, 3.214072162, 3.465771523, 3.726924179, 3.99752516, 4.277569313, 4.567051307, 4.865965629, 5.17430659, 5.492068319, 5.819244766, 6.155829702, 6.50181672, 6.857199231, 7.221970471, 7.596123494, 7.979651177, 8.372546218, 8.774801137, 9.186408276, 9.607359798, 10.03764769, 10.47726376, 10.92619963, 11.38444677, 11.85199644, 12.32883975, 12.81496761, 13.31037077, 13.8150398, 14.32896509, 14.85213686, 15.38454515, 15.92617981, 16.47703054, 17.03708686, 17.60633809, 18.1847734, 18.77238177, 19.36915203, 19.97507281, 20.59013257, 21.2143196, 21.84762202, 22.49002777, 23.14152463, 23.80210018, 24.47174185, 25.1504369, 25.8381724, 26.53493525, 27.2407122, 27.9554898, 28.67925445, 29.41199237, 30.15368961, 30.90433204, 31.66390538, 32.43239516, 33.20978675, 33.99606536, 34.79121601, 35.59522356, 36.40807272, 37.22974799, 38.06023374, 38.89951416, 39.74757327, 40.60439493, 41.46996281, 42.34426044, 43.22727118, 44.11897821, 45.01936456, 45.92841309, 46.84610648, 47.77242727, 48.70735783, 49.65088034, 50.60297685, 51.56362923, 52.5328192, 53.51052829, 54.49673791, 55.49142926, 56.49458341, 57.50618127, 58.52620357, 59.5546309, 60.59144367, 61.63662215, 62.69014643, 63.75199646, 64.82215203, 65.90059276, 66.98729811, 68.0822474, 69.18541978, 70.29679425, 71.41634965, 72.54406466, 73.67991782, 74.8238875, 75.97595192, 77.13608915, 78.30427709, 79.48049352, 80.66471603, 81.85692208, 83.05708897, 84.26519385, 85.48121372, 86.70512544, 87.93690569, 89.17653103, 90.42397786, 91.67922242, 92.94224082, 94.21300902, 95.49150281, 96.77769787, 98.07156969, 99.37309365, 100.682245, 101.9989987, 103.3233299, 104.6552131, 105.9946232, 107.3415346, 108.6959216, 110.0577585, 111.4270193, 112.803678, 114.1877083, 115.579084, 116.9777784, 118.3837651, 119.7970172, 121.2175078, 122.6452099, 124.0800963, 125.5221396, 126.9713125, 128.4275873, 129.8909363, 131.3613316, 132.8387453, 134.3231492, 135.8145151, 137.3128145, 138.818019, 140.3300998, 141.8490283, 143.3747754, 144.9073122, 146.4466094, 147.9926378, 149.5453679, 151.1047701, 152.6708148, 154.2434721, 155.8227122, 157.4085048, 159.00082, 160.5996272, 162.2048962, 163.8165963, 165.4346968, 167.059167, 168.6899759, 170.3270924, 171.9704855, 173.6201238, 175.2759758, 176.9380102, 178.6061952, 180.280499, 181.9608899, 183.6473357, 185.3398045, 187.0382639, 188.7426817, 190.4530253, 192.1692623, 193.89136, 195.6192855, 197.353006, 199.0924884, 200.8376997, 202.5886066, 204.3451758, 206.1073739, 207.8751672, 209.6485221, 211.427405, 213.2117818, 215.0016187, 216.7968815, 218.5975362, 220.4035483, 222.2148835, 224.0315073, 225.8533852, 227.6804825, 229.5127643, 231.3501958, 233.192742, 235.0403679, 236.8930382, 238.7507176, 240.6133709, 242.4809625, 244.353457, 246.2308185, 248.1130115, 250, 251.8917482, 253.7882199, 255.6893793, 257.5951899, 259.5056155, 261.4206199, 263.3401664, 265.2642186, 267.1927398, 269.1256934, 271.0630424, 273.0047501, 274.9507795, 276.9010934, 278.8556549, 280.8144266, 282.7773713, 284.7444516, 286.71563, 288.6908691, 290.6701312, 292.6533787, 294.6405737, 296.6316785, 298.6266551, 300.6254655, 302.6280718, 304.6344358, 306.6445192, 308.6582838, 310.6756913, 312.6967033, 314.7212812, 316.7493866, 318.7809809, 320.8160252, 322.854481, 324.8963094, 326.9414715, 328.9899283, 331.041641, 333.0965704, 335.1546774, 337.2159228, 339.2802673, 341.3476718, 343.4180968, 345.4915028, 347.5678505, 349.6471002, 351.7292125, 353.8141476, 355.9018659, 357.9923276, 360.085493, 362.1813221, 364.2797751, 366.380812, 368.4843928, 370.5904774, 372.6990259, 374.809998, 376.9233535, 379.0390522, 381.1570538, 383.2773181, 385.3998045, 387.5244728, 389.6512825, 391.780193, 393.9111639, 396.0441546, 398.1791244, 400.3160328, 402.454839, 404.5955023, 406.737982, 408.8822373, 411.0282273, 413.1759112, 415.3252481, 417.4761971, 419.6287172, 421.7827675, 423.9383069, 426.0952944, 428.253689, 430.4134495, 432.5745349, 434.7369039, 436.9005154, 439.0653283, 441.2313013, 443.3983931, 445.5665626, 447.7357684, 449.9059692, 452.0771237, 454.2491907, 456.4221286, 458.5958962, 460.7704521, 462.9457549, 465.1217631, 467.2984354, 469.4757302, 471.6536062, 473.8320219, 476.0109357, 478.1903063, 480.3700921, 482.5502516, 484.7307434, 486.9115258, 489.0925575, 491.2737968, 493.4552022, 495.6367323, 497.8183454};
float saddle_lut[LUT_SIZE] = {0.0, 0.004363309284746571, 0.008726535498373935, 0.01308959557134444, 0.01745240643728351, 0.02181488503456112, 0.02617694830787315, 0.03053851320982266, 0.03489949670250097, 0.03925981575906861, 0.043619387365336, 0.04797812852134394, 0.05233595624294383, 0.056692787563377506, 0.06104853953485687, 0.06540312923014306, 0.0697564737441253, 0.07410849019539922, 0.07845909572784494, 0.08280820751220434, 0.08715574274765817, 0.09150161866340238, 0.09584575252022398, 0.10018806161207627, 0.10452846326765346, 0.10886687485196457, 0.11320321376790671, 0.11753739745783764, 0.12186934340514748, 0.12619896913582976, 0.13052619222005157, 0.134850930273723, 0.13917310096006544, 0.1434926219911793, 0.1478094111296106, 0.1521233861899167, 0.15643446504023087, 0.1607425656038261, 0.16504760586067765, 0.1693495038490246, 0.17364817766693033, 0.17794354547384175, 0.18223552549214747, 0.18652403600873463, 0.1908089953765448, 0.19509032201612825, 0.19936793441719716, 0.2036417511401775, 0.20791169081775931, 0.21217767215644623, 0.21643961393810288, 0.22069743502150108, 0.22495105434386498, 0.22920039092241415, 0.2334453638559054, 0.2376858923261731, 0.24192189559966773, 0.24615329302899303, 0.25038000405444144, 0.25460194820552756, 0.25881904510252074, 0.2630312144579748, 0.26723837607825685, 0.27144044986507426, 0.27563735581699916, 0.2798290140309921, 0.2840153447039226, 0.28819626813408933, 0.2923717047227367, 0.296541574975571, 0.3007057995042731, 0.30486429902801077, 0.3090169943749474, 0.31316380648374953, 0.31730465640509214, 0.3214394653031616, 0.3255681544571567, 0.32969064526278724, 0.33380685923377096, 0.33791671800332695, 0.3420201433256687, 0.34611705707749296, 0.35020738125946743, 0.35429103799771583, 0.35836794954530027, 0.3624380382837016, 0.3665012267242973, 0.3705574375098362, 0.374606593415912, 0.378648617352433, 0.3826834323650898, 0.3867109616368206, 0.3907311284892737, 0.39474385638426723, 0.3987490689252462, 0.40274668985873724, 0.40673664307580015, 0.41071885261347724, 0.41469324265623897, 0.41865973753742813, 0.42261826174069944, 0.4265687399014583, 0.4305110968082951, 0.43444525740441703, 0.4383711467890774, 0.4422886902190013, 0.44619781310980877, 0.45009844103743496, 0.45399049973954675, 0.4578739151169567, 0.4617486132350339, 0.4656145203251114, 0.4694715627858908, 0.47331966718484336, 0.4771587602596084, 0.48098876891938763, 0.48480962024633706, 0.4886212414969549, 0.49242356010346705, 0.4962165036752082, 0.49999999999999994, 0.5037739770455263, 0.5075383629607041, 0.511293086077052, 0.5150380749100542, 0.5187732581605213, 0.5224985647159488, 0.5262139236518696, 0.5299192642332049, 0.5336145159156115, 0.5372996083468238, 0.5409744713679939, 0.544639035015027, 0.5482932295199138, 0.5519369853120581, 0.5555702330196022, 0.5591929034707468, 0.5628049276950685, 0.5664062369248328, 0.569996762596303, 0.573576436351046, 0.5771451900372336, 0.5807029557109398, 0.5842496656374343, 0.5877852522924731, 0.5913096483635824, 0.5948227867513413, 0.598324600570659, 0.6018150231520483, 0.6052939880428944, 0.6087614290087207, 0.6122172800344493, 0.6156614753256583, 0.619093949309834, 0.6225146366376195, 0.6259234721840591, 0.6293203910498375, 0.632705328562516, 0.636078220277764, 0.6394390019805847, 0.6427876096865393, 0.6461239796429639, 0.6494480483301837, 0.6527597524627224, 0.6560590289905073, 0.6593458151000688, 0.6626200482157375, 0.6658816660008342, 0.6691306063588582, 0.672366807434668, 0.6755902076156601, 0.6788007455329417, 0.6819983600624985, 0.6851829903263591, 0.6883545756937539, 0.6915130557822694, 0.6946583704589973, 0.6977904598416801, 0.7009092642998509, 0.7040147244559684, 0.7071067811865476, 0.7101853756232853, 0.7132504491541816, 0.7163019434246541, 0.7193398003386511, 0.7223639620597555, 0.7253743710122876, 0.7283709698824004, 0.7313537016191705, 0.7343225094356856, 0.7372773368101241, 0.740218127486832, 0.7431448254773941, 0.7460573750616994, 0.7489557207890021, 0.7518398074789773, 0.7547095802227719, 0.7575649843840496, 0.760405965600031, 0.7632324697825289, 0.766044443118978, 0.7688418320734596, 0.77162458338772, 0.7743926440821856, 0.7771459614569708, 0.7798844830928817, 0.7826081568524138, 0.7853169308807448, 0.7880107536067219, 0.7906895737438434, 0.7933533402912352, 0.796002002534622, 0.7986355100472928, 0.8012538126910607, 0.8038568606172173, 0.8064446042674825, 0.8090169943749475, 0.8115739819650122, 0.8141155183563191, 0.8166415551616789, 0.8191520442889918, 0.8216469379421637, 0.8241261886220157, 0.8265897491271886, 0.8290375725550417, 0.8314696123025452, 0.8338858220671681, 0.8362861558477594, 0.8386705679454239, 0.8410390129643924, 0.8433914458128856, 0.8457278217039733, 0.8480480961564261, 0.8503522249955628, 0.8526401643540922, 0.8549118706729466, 0.8571673007021122, 0.8594064115014527, 0.8616291604415257, 0.8638355052043957, 0.8660254037844386, 0.8681988144891422, 0.8703556959398997, 0.8724960070727971, 0.8746197071393957, 0.8767267557075078, 0.8788171126619654, 0.8808907382053855, 0.8829475928589269, 0.8849876374630418, 0.8870108331782216, 0.8890171414857364, 0.8910065241883678, 0.8929789434111369, 0.8949343616020251, 0.8968727415326884, 0.898794046299167, 0.9006982393225879, 0.9025852843498605, 0.904455145454368, 0.9063077870366499, 0.9081431738250813, 0.9099612708765432, 0.9117620435770885, 0.9135454576426009, 0.9153114791194471, 0.917060074385124, 0.9187912101488983, 0.9205048534524404, 0.9222009716704518, 0.9238795325112867, 0.9255405040175664, 0.9271838545667873, 0.9288095528719241, 0.9304175679820246, 0.9320078692827984, 0.9335804264972017, 0.9351352096860117, 0.9366721892483976, 0.9381913359224842, 0.9396926207859083, 0.9411760152563706, 0.9426414910921784, 0.9440890203927842, 0.9455185755993167, 0.9469301294951056, 0.9483236552061993, 0.949699126201877, 0.9510565162951535, 0.9523957996432784, 0.9537169507482269, 0.9550199444571866, 0.9563047559630354, 0.9575713608048144, 0.958819734868193, 0.9600498543859286, 0.9612616959383189, 0.9624552364536473, 0.963630453208623, 0.964787323828813, 0.9659258262890683, 0.9670459389139431, 0.9681476403781077, 0.9692309097067544, 0.9702957262759965, 0.9713420698132614, 0.9723699203976766, 0.9733792584604485, 0.9743700647852352, 0.9753423205085127, 0.9762960071199334, 0.9772311064626789, 0.9781476007338057, 0.9790454724845838, 0.9799247046208296, 0.9807852804032304, 0.981627183447664, 0.9824503977255097, 0.9832549075639545, 0.9840406976462909, 0.984807753012208, 0.9855560590580777, 0.9862856015372314, 0.9869963665602319, 0.9876883405951378, 0.9883615104677607, 0.9890158633619168, 0.9896513868196702, 0.9902680687415704, 0.9908658973868822, 0.9914448613738104, 0.992004949679715, 0.992546151641322, 0.9930684569549263, 0.9935718556765875, 0.9940563382223196, 0.9945218953682733, 0.9949685182509117, 0.9953961983671787, 0.9958049275746618, 0.9961946980917455, 0.9965655024977614, 0.996917333733128, 0.9972501850994857, 0.9975640502598242, 0.9978589232386035, 0.9981347984218669, 0.9983916705573488, 0.9986295347545738, 0.9988483864849507, 0.9990482215818578, 0.9992290362407229, 0.9993908270190958, 0.9995335908367129, 0.9996573249755573, 0.9997620270799091, 0.9998476951563913, 0.999914327574007, 0.9999619230641713, 0.9999904807207345, 1.0, 0.9999904807207345, 0.9999619230641713, 0.999914327574007, 0.9998476951563913, 0.9997620270799091, 0.9996573249755573, 0.999533590836713, 0.9993908270190958, 0.9992290362407229, 0.9990482215818578, 0.9988483864849507, 0.9986295347545738, 0.9983916705573488, 0.9981347984218669, 0.9978589232386035, 0.9975640502598242, 0.9972501850994857, 0.996917333733128, 0.9965655024977614, 0.9961946980917455, 0.9958049275746618, 0.9953961983671789, 0.9949685182509117, 0.9945218953682734, 0.9940563382223196, 0.9935718556765875, 0.9930684569549263, 0.9925461516413221, 0.992004949679715, 0.9914448613738105, 0.9908658973868824, 0.9902680687415704, 0.9896513868196702, 0.9890158633619168, 0.9883615104677607, 0.9876883405951377, 0.9869963665602319, 0.9862856015372314, 0.9855560590580777, 0.984807753012208, 0.9840406976462909, 0.9832549075639546, 0.9824503977255097, 0.981627183447664, 0.9807852804032304, 0.9799247046208296, 0.9790454724845838, 0.9781476007338057, 0.9772311064626789, 0.9762960071199334, 0.9753423205085128, 0.9743700647852352, 0.9733792584604485, 0.9723699203976767, 0.9713420698132614, 0.9702957262759965, 0.9692309097067544, 0.9681476403781077, 0.9670459389139431, 0.9659258262890683, 0.9647873238288129, 0.963630453208623, 0.9624552364536473, 0.9612616959383189, 0.9600498543859286, 0.958819734868193, 0.9575713608048144, 0.9563047559630355, 0.9550199444571866, 0.9537169507482269, 0.9523957996432784, 0.9510565162951536, 0.949699126201877, 0.9483236552061994, 0.9469301294951057, 0.9455185755993168, 0.9440890203927843, 0.9426414910921784, 0.9411760152563706, 0.9396926207859084, 0.938191335922484, 0.9366721892483976, 0.9351352096860117, 0.9335804264972017, 0.9320078692827986, 0.9304175679820246, 0.9288095528719242, 0.9271838545667874, 0.9255405040175664, 0.9238795325112867, 0.9222009716704519, 0.9205048534524404, 0.9187912101488984, 0.917060074385124, 0.9153114791194472, 0.913545457642601, 0.9117620435770887, 0.9099612708765433, 0.9081431738250815, 0.90630778703665, 0.9044551454543681, 0.9025852843498605, 0.9006982393225879, 0.8987940462991669, 0.8968727415326884, 0.894934361602025, 0.8929789434111369, 0.8910065241883679, 0.8890171414857364, 0.8870108331782218, 0.8849876374630419, 0.8829475928589271, 0.8808907382053855, 0.8788171126619654, 0.8767267557075078, 0.8746197071393959, 0.8724960070727973, 0.8703556959398997, 0.8681988144891425, 0.8681988144891425, 0.8703556959398997, 0.8724960070727973, 0.8746197071393959, 0.8767267557075078, 0.8788171126619654, 0.8808907382053855, 0.8829475928589271, 0.8849876374630419, 0.8870108331782218, 0.8890171414857364, 0.8910065241883679, 0.8929789434111369, 0.894934361602025, 0.8968727415326884, 0.8987940462991669, 0.9006982393225879, 0.9025852843498605, 0.9044551454543681, 0.90630778703665, 0.9081431738250815, 0.9099612708765433, 0.9117620435770887, 0.913545457642601, 0.9153114791194472, 0.917060074385124, 0.9187912101488984, 0.9205048534524404, 0.9222009716704519, 0.9238795325112867, 0.9255405040175664, 0.9271838545667874, 0.9288095528719242, 0.9304175679820246, 0.9320078692827986, 0.9335804264972017, 0.9351352096860117, 0.9366721892483976, 0.938191335922484, 0.9396926207859084, 0.9411760152563706, 0.9426414910921784, 0.9440890203927843, 0.9455185755993168, 0.9469301294951057, 0.9483236552061994, 0.949699126201877, 0.9510565162951536, 0.9523957996432784, 0.9537169507482269, 0.9550199444571866, 0.9563047559630355, 0.9575713608048144, 0.958819734868193, 0.9600498543859286, 0.9612616959383189, 0.9624552364536473, 0.963630453208623, 0.9647873238288129, 0.9659258262890683, 0.9670459389139431, 0.9681476403781077, 0.9692309097067544, 0.9702957262759965, 0.9713420698132614, 0.9723699203976767, 0.9733792584604485, 0.9743700647852352, 0.9753423205085128, 0.9762960071199334, 0.9772311064626789, 0.9781476007338057, 0.9790454724845838, 0.9799247046208296, 0.9807852804032304, 0.981627183447664, 0.9824503977255097, 0.9832549075639546, 0.9840406976462909, 0.984807753012208, 0.9855560590580777, 0.9862856015372314, 0.9869963665602319, 0.9876883405951377, 0.9883615104677607, 0.9890158633619168, 0.9896513868196702, 0.9902680687415704, 0.9908658973868824, 0.9914448613738105, 0.992004949679715, 0.9925461516413221, 0.9930684569549263, 0.9935718556765875, 0.9940563382223196, 0.9945218953682734, 0.9949685182509117, 0.9953961983671789, 0.9958049275746618, 0.9961946980917455, 0.9965655024977614, 0.996917333733128, 0.9972501850994857, 0.9975640502598242, 0.9978589232386035, 0.9981347984218669, 0.9983916705573488, 0.9986295347545738, 0.9988483864849507, 0.9990482215818578, 0.9992290362407229, 0.9993908270190958, 0.999533590836713, 0.9996573249755573, 0.9997620270799091, 0.9998476951563913, 0.999914327574007, 0.9999619230641713, 0.9999904807207345, 1.0, 0.9999904807207345, 0.9999619230641713, 0.999914327574007, 0.9998476951563913, 0.9997620270799091, 0.9996573249755573, 0.9995335908367129, 0.9993908270190958, 0.9992290362407229, 0.9990482215818578, 0.9988483864849507, 0.9986295347545738, 0.9983916705573488, 0.9981347984218669, 0.9978589232386035, 0.9975640502598242, 0.9972501850994857, 0.996917333733128, 0.9965655024977614, 0.9961946980917455, 0.9958049275746618, 0.9953961983671787, 0.9949685182509117, 0.9945218953682733, 0.9940563382223196, 0.9935718556765875, 0.9930684569549263, 0.992546151641322, 0.992004949679715, 0.9914448613738104, 0.9908658973868822, 0.9902680687415704, 0.9896513868196702, 0.9890158633619168, 0.9883615104677607, 0.9876883405951378, 0.9869963665602319, 0.9862856015372314, 0.9855560590580777, 0.984807753012208, 0.9840406976462909, 0.9832549075639545, 0.9824503977255097, 0.981627183447664, 0.9807852804032304, 0.9799247046208296, 0.9790454724845838, 0.9781476007338057, 0.9772311064626789, 0.9762960071199334, 0.9753423205085127, 0.9743700647852352, 0.9733792584604485, 0.9723699203976766, 0.9713420698132614, 0.9702957262759965, 0.9692309097067544, 0.9681476403781077, 0.9670459389139431, 0.9659258262890683, 0.964787323828813, 0.963630453208623, 0.9624552364536473, 0.9612616959383189, 0.9600498543859286, 0.958819734868193, 0.9575713608048144, 0.9563047559630354, 0.9550199444571866, 0.9537169507482269, 0.9523957996432784, 0.9510565162951535, 0.949699126201877, 0.9483236552061993, 0.9469301294951056, 0.9455185755993167, 0.9440890203927842, 0.9426414910921784, 0.9411760152563706, 0.9396926207859083, 0.9381913359224842, 0.9366721892483976, 0.9351352096860117, 0.9335804264972017, 0.9320078692827984, 0.9304175679820246, 0.9288095528719241, 0.9271838545667873, 0.9255405040175664, 0.9238795325112867, 0.9222009716704518, 0.9205048534524404, 0.9187912101488983, 0.917060074385124, 0.9153114791194471, 0.9135454576426009, 0.9117620435770885, 0.9099612708765432, 0.9081431738250813, 0.9063077870366499, 0.904455145454368, 0.9025852843498605, 0.9006982393225879, 0.898794046299167, 0.8968727415326884, 0.8949343616020251, 0.8929789434111369, 0.8910065241883678, 0.8890171414857364, 0.8870108331782216, 0.8849876374630418, 0.8829475928589269, 0.8808907382053855, 0.8788171126619654, 0.8767267557075078, 0.8746197071393957, 0.8724960070727971, 0.8703556959398997, 0.8681988144891422, 0.8660254037844386, 0.8638355052043957, 0.8616291604415257, 0.8594064115014527, 0.8571673007021122, 0.8549118706729466, 0.8526401643540922, 0.8503522249955628, 0.8480480961564261, 0.8457278217039733, 0.8433914458128856, 0.8410390129643924, 0.8386705679454239, 0.8362861558477594, 0.8338858220671681, 0.8314696123025452, 0.8290375725550417, 0.8265897491271886, 0.8241261886220157, 0.8216469379421637, 0.8191520442889918, 0.8166415551616789, 0.8141155183563191, 0.8115739819650122, 0.8090169943749475, 0.8064446042674825, 0.8038568606172173, 0.8012538126910607, 0.7986355100472928, 0.796002002534622, 0.7933533402912352, 0.7906895737438434, 0.7880107536067219, 0.7853169308807448, 0.7826081568524138, 0.7798844830928817, 0.7771459614569708, 0.7743926440821856, 0.77162458338772, 0.7688418320734596, 0.766044443118978, 0.7632324697825289, 0.760405965600031, 0.7575649843840496, 0.7547095802227719, 0.7518398074789773, 0.7489557207890021, 0.7460573750616994, 0.7431448254773941, 0.740218127486832, 0.7372773368101241, 0.7343225094356856, 0.7313537016191705, 0.7283709698824004, 0.7253743710122876, 0.7223639620597555, 0.7193398003386511, 0.7163019434246541, 0.7132504491541816, 0.7101853756232853, 0.7071067811865476, 0.7040147244559684, 0.7009092642998509, 0.6977904598416801, 0.6946583704589973, 0.6915130557822694, 0.6883545756937539, 0.6851829903263591, 0.6819983600624985, 0.6788007455329417, 0.6755902076156601, 0.672366807434668, 0.6691306063588582, 0.6658816660008342, 0.6626200482157375, 0.6593458151000688, 0.6560590289905073, 0.6527597524627224, 0.6494480483301837, 0.6461239796429639, 0.6427876096865393, 0.6394390019805847, 0.636078220277764, 0.632705328562516, 0.6293203910498375, 0.6259234721840591, 0.6225146366376195, 0.619093949309834, 0.6156614753256583, 0.6122172800344493, 0.6087614290087207, 0.6052939880428944, 0.6018150231520483, 0.598324600570659, 0.5948227867513413, 0.5913096483635824, 0.5877852522924731, 0.5842496656374343, 0.5807029557109398, 0.5771451900372336, 0.573576436351046, 0.569996762596303, 0.5664062369248328, 0.5628049276950685, 0.5591929034707468, 0.5555702330196022, 0.5519369853120581, 0.5482932295199138, 0.544639035015027, 0.5409744713679939, 0.5372996083468238, 0.5336145159156115, 0.5299192642332049, 0.5262139236518696, 0.5224985647159488, 0.5187732581605213, 0.5150380749100542, 0.511293086077052, 0.5075383629607041, 0.5037739770455263, 0.49999999999999994, 0.4962165036752082, 0.49242356010346705, 0.4886212414969549, 0.48480962024633706, 0.48098876891938763, 0.4771587602596084, 0.47331966718484336, 0.4694715627858908, 0.4656145203251114, 0.4617486132350339, 0.4578739151169567, 0.45399049973954675, 0.45009844103743496, 0.44619781310980877, 0.4422886902190013, 0.4383711467890774, 0.43444525740441703, 0.4305110968082951, 0.4265687399014583, 0.42261826174069944, 0.41865973753742813, 0.41469324265623897, 0.41071885261347724, 0.40673664307580015, 0.40274668985873724, 0.3987490689252462, 0.39474385638426723, 0.3907311284892737, 0.3867109616368206, 0.3826834323650898, 0.378648617352433, 0.374606593415912, 0.3705574375098362, 0.3665012267242973, 0.3624380382837016, 0.35836794954530027, 0.35429103799771583, 0.35020738125946743, 0.34611705707749296, 0.3420201433256687, 0.33791671800332695, 0.33380685923377096, 0.32969064526278724, 0.3255681544571567, 0.3214394653031616, 0.31730465640509214, 0.31316380648374953, 0.3090169943749474, 0.30486429902801077, 0.3007057995042731, 0.296541574975571, 0.2923717047227367, 0.28819626813408933, 0.2840153447039226, 0.2798290140309921, 0.27563735581699916, 0.27144044986507426, 0.26723837607825685, 0.2630312144579748, 0.25881904510252074, 0.25460194820552756, 0.25038000405444144, 0.24615329302899303, 0.24192189559966773, 0.2376858923261731, 0.2334453638559054, 0.22920039092241415, 0.22495105434386498, 0.22069743502150108, 0.21643961393810288, 0.21217767215644623, 0.20791169081775931, 0.2036417511401775, 0.19936793441719716, 0.19509032201612825, 0.1908089953765448, 0.18652403600873463, 0.18223552549214747, 0.17794354547384175, 0.17364817766693033, 0.1693495038490246, 0.16504760586067765, 0.1607425656038261, 0.15643446504023087, 0.1521233861899167, 0.1478094111296106, 0.1434926219911793, 0.13917310096006544, 0.134850930273723, 0.13052619222005157, 0.12619896913582976, 0.12186934340514748, 0.11753739745783764, 0.11320321376790671, 0.10886687485196457, 0.10452846326765346, 0.10018806161207627, 0.09584575252022398, 0.09150161866340238, 0.08715574274765817, 0.08280820751220434, 0.07845909572784494, 0.07410849019539922, 0.0697564737441253, 0.06540312923014306, 0.06104853953485687, 0.056692787563377506, 0.05233595624294383, 0.04797812852134394, 0.043619387365336, 0.03925981575906861, 0.03489949670250097, 0.03053851320982266, 0.02617694830787315, 0.02181488503456112, 0.01745240643728351, 0.01308959557134444, 0.008726535498373935, 0.004363309284746571, 0.0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
float sin_lut[LUT_SIZE] = {0.0, 0.004363309284746571, 0.008726535498373935, 0.01308959557134444, 0.01745240643728351, 0.02181488503456112, 0.02617694830787315, 0.03053851320982266, 0.03489949670250097, 0.03925981575906861, 0.043619387365336, 0.04797812852134394, 0.05233595624294383, 0.05669278756337751, 0.06104853953485687, 0.06540312923014306, 0.0697564737441253, 0.07410849019539924, 0.07845909572784494, 0.08280820751220433, 0.08715574274765817, 0.09150161866340238, 0.09584575252022398, 0.10018806161207627, 0.10452846326765346, 0.10886687485196457, 0.11320321376790672, 0.11753739745783764, 0.12186934340514748, 0.12619896913582976, 0.13052619222005157, 0.134850930273723, 0.13917310096006544, 0.14349262199117932, 0.14780941112961063, 0.1521233861899167, 0.15643446504023087, 0.1607425656038261, 0.16504760586067763, 0.16934950384902459, 0.17364817766693033, 0.17794354547384172, 0.18223552549214747, 0.1865240360087346, 0.1908089953765448, 0.19509032201612825, 0.19936793441719716, 0.2036417511401775, 0.20791169081775931, 0.21217767215644626, 0.21643961393810288, 0.22069743502150108, 0.224951054343865, 0.22920039092241415, 0.2334453638559054, 0.2376858923261731, 0.24192189559966773, 0.24615329302899303, 0.25038000405444144, 0.25460194820552756, 0.25881904510252074, 0.2630312144579748, 0.26723837607825685, 0.27144044986507426, 0.27563735581699916, 0.2798290140309921, 0.28401534470392265, 0.2881962681340893, 0.29237170472273677, 0.29654157497557093, 0.3007057995042731, 0.30486429902801077, 0.3090169943749474, 0.31316380648374953, 0.31730465640509214, 0.3214394653031616, 0.32556815445715664, 0.3296906452627873, 0.3338068592337709, 0.33791671800332695, 0.3420201433256687, 0.34611705707749296, 0.3502073812594674, 0.35429103799771583, 0.35836794954530027, 0.36243803828370164, 0.36650122672429725, 0.3705574375098362, 0.374606593415912, 0.378648617352433, 0.3826834323650898, 0.3867109616368206, 0.3907311284892737, 0.3947438563842672, 0.3987490689252462, 0.40274668985873724, 0.40673664307580015, 0.41071885261347724, 0.414693242656239, 0.41865973753742813, 0.42261826174069944, 0.4265687399014583, 0.4305110968082951, 0.43444525740441703, 0.4383711467890774, 0.4422886902190013, 0.44619781310980877, 0.45009844103743496, 0.45399049973954675, 0.4578739151169567, 0.4617486132350339, 0.4656145203251114, 0.4694715627858908, 0.47331966718484336, 0.4771587602596084, 0.48098876891938763, 0.48480962024633706, 0.4886212414969549, 0.49242356010346705, 0.4962165036752082, 0.49999999999999994, 0.5037739770455263, 0.5075383629607041, 0.511293086077052, 0.5150380749100542, 0.5187732581605213, 0.5224985647159488, 0.5262139236518696, 0.5299192642332049, 0.5336145159156115, 0.5372996083468238, 0.5409744713679939, 0.5446390350150271, 0.5482932295199138, 0.5519369853120581, 0.5555702330196022, 0.5591929034707469, 0.5628049276950685, 0.5664062369248328, 0.569996762596303, 0.573576436351046, 0.5771451900372335, 0.5807029557109398, 0.5842496656374344, 0.5877852522924731, 0.5913096483635824, 0.5948227867513413, 0.5983246005706591, 0.6018150231520483, 0.6052939880428944, 0.6087614290087207, 0.6122172800344493, 0.6156614753256582, 0.619093949309834, 0.6225146366376196, 0.6259234721840591, 0.6293203910498374, 0.6327053285625159, 0.636078220277764, 0.6394390019805848, 0.6427876096865393, 0.6461239796429638, 0.6494480483301837, 0.6527597524627224, 0.6560590289905072, 0.6593458151000688, 0.6626200482157375, 0.6658816660008343, 0.6691306063588582, 0.672366807434668, 0.6755902076156602, 0.6788007455329417, 0.6819983600624985, 0.6851829903263591, 0.6883545756937539, 0.6915130557822693, 0.6946583704589973, 0.6977904598416801, 0.7009092642998509, 0.7040147244559684, 0.7071067811865476, 0.7101853756232853, 0.7132504491541816, 0.7163019434246541, 0.7193398003386511, 0.7223639620597555, 0.7253743710122875, 0.7283709698824004, 0.7313537016191705, 0.7343225094356856, 0.7372773368101241, 0.740218127486832, 0.7431448254773941, 0.7460573750616994, 0.7489557207890021, 0.7518398074789773, 0.754709580222772, 0.7575649843840495, 0.760405965600031, 0.7632324697825289, 0.766044443118978, 0.7688418320734596, 0.77162458338772, 0.7743926440821856, 0.7771459614569708, 0.7798844830928817, 0.7826081568524138, 0.7853169308807448, 0.788010753606722, 0.7906895737438433, 0.7933533402912352, 0.796002002534622, 0.7986355100472928, 0.8012538126910607, 0.8038568606172173, 0.8064446042674825, 0.8090169943749475, 0.8115739819650122, 0.8141155183563191, 0.8166415551616789, 0.8191520442889918, 0.8216469379421637, 0.8241261886220157, 0.8265897491271886, 0.8290375725550417, 0.8314696123025452, 0.8338858220671681, 0.8362861558477594, 0.8386705679454239, 0.8410390129643924, 0.8433914458128856, 0.8457278217039733, 0.8480480961564261, 0.8503522249955628, 0.8526401643540922, 0.8549118706729466, 0.8571673007021122, 0.8594064115014527, 0.8616291604415257, 0.8638355052043957, 0.8660254037844386, 0.8681988144891423, 0.8703556959398997, 0.8724960070727971, 0.8746197071393957, 0.8767267557075077, 0.8788171126619654, 0.8808907382053855, 0.8829475928589269, 0.8849876374630418, 0.8870108331782216, 0.8890171414857364, 0.8910065241883678, 0.8929789434111369, 0.8949343616020251, 0.8968727415326884, 0.898794046299167, 0.9006982393225879, 0.9025852843498605, 0.9044551454543679, 0.9063077870366499, 0.9081431738250813, 0.9099612708765432, 0.9117620435770886, 0.9135454576426009, 0.9153114791194471, 0.917060074385124, 0.9187912101488982, 0.9205048534524403, 0.9222009716704518, 0.9238795325112867, 0.9255405040175664, 0.9271838545667874, 0.9288095528719242, 0.9304175679820246, 0.9320078692827984, 0.9335804264972017, 0.9351352096860117, 0.9366721892483976, 0.9381913359224842, 0.9396926207859083, 0.9411760152563706, 0.9426414910921783, 0.9440890203927842, 0.9455185755993167, 0.9469301294951057, 0.9483236552061993, 0.949699126201877, 0.9510565162951535, 0.9523957996432784, 0.9537169507482268, 0.9550199444571865, 0.9563047559630354, 0.9575713608048144, 0.958819734868193, 0.9600498543859287, 0.9612616959383189, 0.9624552364536473, 0.963630453208623, 0.9647873238288129, 0.9659258262890683, 0.9670459389139431, 0.9681476403781077, 0.9692309097067544, 0.9702957262759965, 0.9713420698132614, 0.9723699203976766, 0.9733792584604485, 0.9743700647852352, 0.9753423205085127, 0.9762960071199334, 0.9772311064626789, 0.9781476007338056, 0.9790454724845838, 0.9799247046208296, 0.9807852804032304, 0.981627183447664, 0.9824503977255098, 0.9832549075639546, 0.9840406976462909, 0.984807753012208, 0.9855560590580777, 0.9862856015372313, 0.9869963665602319, 0.9876883405951378, 0.9883615104677607, 0.9890158633619168, 0.9896513868196702, 0.9902680687415703, 0.9908658973868822, 0.9914448613738104, 0.992004949679715, 0.992546151641322, 0.9930684569549263, 0.9935718556765875, 0.9940563382223196, 0.9945218953682733, 0.9949685182509117, 0.9953961983671787, 0.9958049275746618, 0.9961946980917455, 0.9965655024977614, 0.996917333733128, 0.9972501850994857, 0.9975640502598242, 0.9978589232386035, 0.9981347984218669, 0.9983916705573488, 0.9986295347545738, 0.9988483864849507, 0.9990482215818578, 0.9992290362407229, 0.9993908270190958, 0.9995335908367129, 0.9996573249755573, 0.9997620270799091, 0.9998476951563913, 0.999914327574007, 0.9999619230641713, 0.9999904807207345, 1.0, 0.9999904807207345, 0.9999619230641713, 0.999914327574007, 0.9998476951563913, 0.9997620270799091, 0.9996573249755573, 0.9995335908367129, 0.9993908270190958, 0.9992290362407229, 0.9990482215818578, 0.9988483864849507, 0.9986295347545738, 0.9983916705573488, 0.9981347984218669, 0.9978589232386035, 0.9975640502598242, 0.9972501850994857, 0.996917333733128, 0.9965655024977614, 0.9961946980917455, 0.9958049275746618, 0.9953961983671789, 0.9949685182509117, 0.9945218953682734, 0.9940563382223196, 0.9935718556765875, 0.9930684569549263, 0.9925461516413221, 0.992004949679715, 0.9914448613738105, 0.9908658973868822, 0.9902680687415704, 0.9896513868196702, 0.9890158633619168, 0.9883615104677607, 0.9876883405951377, 0.9869963665602319, 0.9862856015372314, 0.9855560590580777, 0.984807753012208, 0.9840406976462909, 0.9832549075639546, 0.9824503977255098, 0.981627183447664, 0.9807852804032305, 0.9799247046208296, 0.9790454724845838, 0.9781476007338057, 0.9772311064626789, 0.9762960071199334, 0.9753423205085127, 0.9743700647852352, 0.9733792584604485, 0.9723699203976767, 0.9713420698132614, 0.9702957262759965, 0.9692309097067544, 0.9681476403781077, 0.9670459389139432, 0.9659258262890683, 0.964787323828813, 0.963630453208623, 0.9624552364536473, 0.9612616959383189, 0.9600498543859287, 0.958819734868193, 0.9575713608048144, 0.9563047559630355, 0.9550199444571866, 0.9537169507482269, 0.9523957996432784, 0.9510565162951536, 0.9496991262018769, 0.9483236552061994, 0.9469301294951057, 0.9455185755993168, 0.9440890203927843, 0.9426414910921783, 0.9411760152563707, 0.9396926207859084, 0.9381913359224842, 0.9366721892483976, 0.9351352096860117, 0.9335804264972017, 0.9320078692827986, 0.9304175679820246, 0.9288095528719242, 0.9271838545667874, 0.9255405040175664, 0.9238795325112867, 0.9222009716704518, 0.9205048534524404, 0.9187912101488983, 0.9170600743851242, 0.9153114791194472, 0.913545457642601, 0.9117620435770886, 0.9099612708765433, 0.9081431738250815, 0.90630778703665, 0.904455145454368, 0.9025852843498605, 0.9006982393225879, 0.8987940462991669, 0.8968727415326884, 0.894934361602025, 0.8929789434111371, 0.8910065241883679, 0.8890171414857366, 0.8870108331782218, 0.8849876374630419, 0.8829475928589271, 0.8808907382053855, 0.8788171126619654, 0.8767267557075078, 0.8746197071393959, 0.8724960070727971, 0.8703556959398997, 0.8681988144891423, 0.8660254037844387, 0.8638355052043957, 0.8616291604415257, 0.8594064115014528, 0.8571673007021123, 0.8549118706729467, 0.8526401643540923, 0.8503522249955631, 0.8480480961564261, 0.8457278217039732, 0.8433914458128858, 0.8410390129643925, 0.838670567945424, 0.8362861558477593, 0.8338858220671682, 0.8314696123025451, 0.8290375725550417, 0.8265897491271886, 0.8241261886220158, 0.8216469379421637, 0.819152044288992, 0.816641555161679, 0.8141155183563192, 0.8115739819650124, 0.8090169943749475, 0.8064446042674828, 0.8038568606172174, 0.8012538126910607, 0.7986355100472927, 0.7960020025346222, 0.7933533402912352, 0.7906895737438435, 0.788010753606722, 0.7853169308807448, 0.782608156852414, 0.7798844830928817, 0.777145961456971, 0.7743926440821857, 0.7716245833877202, 0.7688418320734596, 0.766044443118978, 0.763232469782529, 0.7604059656000309, 0.7575649843840495, 0.7547095802227718, 0.7518398074789774, 0.7489557207890021, 0.7460573750616996, 0.7431448254773942, 0.7402181274868322, 0.7372773368101241, 0.7343225094356857, 0.7313537016191706, 0.7283709698824006, 0.7253743710122877, 0.7223639620597556, 0.7193398003386514, 0.7163019434246544, 0.7132504491541816, 0.7101853756232853, 0.7071067811865476, 0.7040147244559682, 0.700909264299851, 0.6977904598416802, 0.6946583704589971, 0.6915130557822694, 0.6883545756937539, 0.6851829903263593, 0.6819983600624985, 0.678800745532942, 0.6755902076156604, 0.6723668074346684, 0.6691306063588583, 0.6658816660008343, 0.6626200482157374, 0.6593458151000686, 0.6560590289905073, 0.6527597524627223, 0.6494480483301838, 0.6461239796429638, 0.6427876096865395, 0.6394390019805848, 0.6360782202777642, 0.6327053285625162, 0.6293203910498377, 0.6259234721840592, 0.6225146366376196, 0.6190939493098342, 0.6156614753256584, 0.6122172800344493, 0.6087614290087204, 0.6052939880428945, 0.6018150231520482, 0.5983246005706592, 0.5948227867513413, 0.5913096483635826, 0.5877852522924732, 0.5842496656374344, 0.5807029557109399, 0.5771451900372336, 0.5735764363510464, 0.5699967625963032, 0.5664062369248332, 0.5628049276950687, 0.5591929034707469, 0.5555702330196022, 0.5519369853120583, 0.5482932295199138, 0.5446390350150269, 0.540974471367994, 0.5372996083468238, 0.5336145159156117, 0.5299192642332049, 0.5262139236518698, 0.5224985647159489, 0.5187732581605218, 0.5150380749100544, 0.5112930860770525, 0.5075383629607044, 0.5037739770455264, 0.49999999999999994, 0.49621650367520803, 0.49242356010346716, 0.48862124149695485, 0.48480962024633717, 0.48098876891938763, 0.4771587602596086, 0.4733196671848435, 0.4694715627858911, 0.4656145203251116, 0.4617486132350339, 0.457873915116957, 0.45399049973954686, 0.45009844103743535, 0.446197813109809, 0.4422886902190013, 0.4383711467890773, 0.4344452574044172, 0.4305110968082951, 0.42656873990145816, 0.4226182617406995, 0.41865973753742797, 0.4146932426562392, 0.41071885261347724, 0.40673664307580043, 0.4027466898587373, 0.39874906892524653, 0.3947438563842674, 0.39073112848927416, 0.3867109616368209, 0.3826834323650899, 0.37864861735243294, 0.37460659341591224, 0.3705574375098363, 0.36650122672429714, 0.36243803828370175, 0.3583679495453002, 0.35429103799771605, 0.35020738125946754, 0.3461170570774933, 0.3420201433256689, 0.33791671800332695, 0.3338068592337712, 0.32969064526278735, 0.32556815445715703, 0.32143946530316175, 0.31730465640509214, 0.3131638064837494, 0.3090169943749475, 0.30486429902801077, 0.30070579950427334, 0.296541574975571, 0.29237170472273705, 0.28819626813408905, 0.2840153447039226, 0.2798290140309923, 0.27563735581699966, 0.27144044986507415, 0.267238376078257, 0.2630312144579752, 0.258819045102521, 0.2546019482055277, 0.25038000405444133, 0.24615329302899322, 0.24192189559966773, 0.23768589232617293, 0.23344536385590553, 0.22920039092241454, 0.22495105434386478, 0.22069743502150113, 0.21643961393810318, 0.21217767215644684, 0.20791169081775931, 0.2036417511401777, 0.1993679344171977, 0.19509032201612816, 0.19080899537654497, 0.18652403600873463, 0.18223552549214772, 0.17794354547384186, 0.17364817766693028, 0.1693495038490248, 0.1650476058606781, 0.16074256560382594, 0.15643446504023098, 0.15212338618991708, 0.14780941112961038, 0.14349262199117935, 0.13917310096006574, 0.13485093027372358, 0.13052619222005157, 0.12619896913583, 0.12186934340514755, 0.11753739745783798, 0.11320321376790689, 0.10886687485196457, 0.10452846326765373, 0.10018806161207594, 0.09584575252022391, 0.09150161866340258, 0.08715574274765864, 0.08280820751220419, 0.07845909572784507, 0.07410849019539963, 0.06975647374412552, 0.06540312923014312, 0.06104853953485719, 0.05669278756337765, 0.05233595624294381, 0.04797812852134419, 0.04361938736533607, 0.03925981575906895, 0.0348994967025007, 0.03053851320982266, 0.026176948307873423, 0.021814885034560774, 0.01745240643728344, 0.013089595571344636, 0.008726535498374403, 0.004363309284746422, 1.2246467991473532e-16, -0.004363309284746176, -0.008726535498373713, -0.013089595571344391, -0.017452406437283192, -0.021814885034560975, -0.026176948307873177, -0.030538513209822857, -0.0348994967025009, -0.03925981575906826, -0.04361938736533627, -0.04797812852134395, -0.052335956242943564, -0.056692787563376965, -0.06104853953485694, -0.06540312923014287, -0.06975647374412483, -0.07410849019539939, -0.07845909572784482, -0.08280820751220438, -0.08715574274765794, -0.09150161866340234, -0.0958457525202241, -0.10018806161207613, -0.10452846326765305, -0.10886687485196476, -0.11320321376790664, -0.1175373974578373, -0.12186934340514774, -0.12619896913582976, -0.13052619222005132, -0.13485093027372247, -0.13917310096006552, -0.1434926219911791, -0.1478094111296106, -0.15212338618991642, -0.15643446504023073, -0.16074256560382613, -0.16504760586067743, -0.16934950384902456, -0.17364817766693047, -0.1779435454738416, -0.18223552549214703, -0.18652403600873482, -0.19080899537654472, -0.19509032201612792, -0.19936793441719658, -0.20364175114017746, -0.20791169081775907, -0.21217767215644617, -0.21643961393810293, -0.22069743502150088, -0.22495105434386498, -0.22920039092241387, -0.23344536385590572, -0.23768589232617313, -0.2419218955996675, -0.24615329302899255, -0.25038000405444155, -0.25460194820552745, -0.25881904510252035, -0.26303121445797495, -0.2672383760782568, -0.27144044986507393, -0.275637355816999, -0.27982901403099203, -0.28401534470392237, -0.2881962681340892, -0.2923717047227364, -0.29654157497557115, -0.30070579950427306, -0.3048642990280105, -0.30901699437494773, -0.3131638064837496, -0.3173046564050919, -0.3214394653031611, -0.32556815445715676, -0.32969064526278713, -0.3338068592337705, -0.33791671800332673, -0.34202014332566866, -0.34611705707749263, -0.35020738125946727, -0.35429103799771583, -0.35836794954530043, -0.3624380382837015, -0.3665012267242969, -0.37055743750983644, -0.374606593415912, -0.3786486173524327, -0.3826834323650892, -0.38671096163682067, -0.39073112848927355, -0.3947438563842668, -0.3987490689252463, -0.4027466898587371, -0.4067366430757998, -0.410718852613477, -0.41469324265623897, -0.41865973753742813, -0.4226182617406993, -0.42656873990145794, -0.4305110968082953, -0.434445257404417, -0.43837114678907707, -0.44228869021900147, -0.44619781310980877, -0.45009844103743474, -0.45399049973954625, -0.4578739151169568, -0.4617486132350337, -0.46561452032511136, -0.46947156278589086, -0.47331966718484325, -0.4771587602596084, -0.4809887689193874, -0.48480962024633695, -0.488621241496955, -0.49242356010346694, -0.4962165036752078, -0.5000000000000001, -0.5037739770455262, -0.5075383629607039, -0.5112930860770523, -0.5150380749100542, -0.5187732581605212, -0.5224985647159487, -0.5262139236518696, -0.5299192642332048, -0.5336145159156115, -0.5372996083468236, -0.5409744713679938, -0.5446390350150271, -0.5482932295199135, -0.5519369853120585, -0.5555702330196023, -0.5591929034707467, -0.5628049276950682, -0.5664062369248329, -0.5699967625963029, -0.5735764363510458, -0.5771451900372334, -0.5807029557109398, -0.5842496656374342, -0.587785252292473, -0.5913096483635824, -0.5948227867513415, -0.598324600570659, -0.601815023152048, -0.6052939880428946, -0.6087614290087207, -0.6122172800344491, -0.6156614753256578, -0.6190939493098341, -0.6225146366376194, -0.6259234721840587, -0.6293203910498376, -0.6327053285625159, -0.6360782202777636, -0.6394390019805846, -0.6427876096865393, -0.646123979642964, -0.6494480483301835, -0.6527597524627221, -0.6560590289905074, -0.6593458151000688, -0.6626200482157372, -0.6658816660008345, -0.6691306063588582, -0.6723668074346678, -0.6755902076156598, -0.6788007455329418, -0.6819983600624984, -0.6851829903263588, -0.6883545756937537, -0.6915130557822693, -0.6946583704589973, -0.69779045984168, -0.7009092642998509, -0.7040147244559685, -0.7071067811865475, -0.7101853756232851, -0.7132504491541817, -0.7163019434246541, -0.7193398003386509, -0.7223639620597552, -0.7253743710122876, -0.7283709698824001, -0.7313537016191701, -0.7343225094356856, -0.7372773368101239, -0.740218127486832, -0.743144825477394, -0.7460573750616994, -0.7489557207890022, -0.7518398074789773, -0.7547095802227717, -0.7575649843840494, -0.7604059656000306, -0.7632324697825289, -0.7660444431189779, -0.7688418320734598, -0.77162458338772, -0.7743926440821854, -0.7771459614569711, -0.7798844830928819, -0.7826081568524138, -0.7853169308807447, -0.7880107536067221, -0.7906895737438433, -0.7933533402912349, -0.7960020025346223, -0.7986355100472928, -0.8012538126910606, -0.8038568606172171, -0.8064446042674827, -0.8090169943749473, -0.8115739819650121, -0.8141155183563188, -0.8166415551616789, -0.8191520442889916, -0.8216469379421633, -0.8241261886220157, -0.8265897491271885, -0.8290375725550414, -0.8314696123025448, -0.8338858220671681, -0.8362861558477592, -0.8386705679454242, -0.8410390129643924, -0.8433914458128855, -0.8457278217039733, -0.848048096156426, -0.8503522249955627, -0.8526401643540924, -0.8549118706729466, -0.8571673007021121, -0.8594064115014529, -0.8616291604415258, -0.8638355052043956, -0.8660254037844385, -0.8681988144891424, -0.8703556959398996, -0.872496007072797, -0.8746197071393959, -0.8767267557075077, -0.8788171126619653, -0.8808907382053852, -0.882947592858927, -0.8849876374630418, -0.8870108331782215, -0.8890171414857364, -0.8910065241883678, -0.8929789434111368, -0.8949343616020248, -0.8968727415326883, -0.8987940462991668, -0.9006982393225876, -0.9025852843498606, -0.9044551454543679, -0.9063077870366497, -0.9081431738250814, -0.9099612708765431, -0.9117620435770887, -0.913545457642601, -0.9153114791194471, -0.9170600743851243, -0.9187912101488984, -0.9205048534524403, -0.9222009716704517, -0.9238795325112868, -0.9255405040175664, -0.9271838545667873, -0.9288095528719243, -0.9304175679820246, -0.9320078692827984, -0.9335804264972016, -0.9351352096860117, -0.9366721892483976, -0.938191335922484, -0.9396926207859082, -0.9411760152563706, -0.9426414910921783, -0.9440890203927841, -0.9455185755993168, -0.9469301294951056, -0.9483236552061992, -0.9496991262018767, -0.9510565162951535, -0.9523957996432783, -0.9537169507482267, -0.9550199444571866, -0.9563047559630353, -0.9575713608048145, -0.958819734868193, -0.9600498543859286, -0.961261695938319, -0.9624552364536473, -0.963630453208623, -0.964787323828813, -0.9659258262890683, -0.9670459389139431, -0.9681476403781076, -0.9692309097067544, -0.9702957262759965, -0.9713420698132613, -0.9723699203976767, -0.9733792584604485, -0.9743700647852351, -0.9753423205085126, -0.9762960071199334, -0.9772311064626789, -0.9781476007338056, -0.9790454724845837, -0.9799247046208296, -0.9807852804032303, -0.9816271834476639, -0.9824503977255097, -0.9832549075639545, -0.9840406976462908, -0.984807753012208, -0.9855560590580776, -0.9862856015372313, -0.9869963665602319, -0.9876883405951377, -0.9883615104677607, -0.9890158633619168, -0.9896513868196702, -0.9902680687415704, -0.9908658973868822, -0.9914448613738104, -0.992004949679715, -0.9925461516413221, -0.9930684569549263, -0.9935718556765875, -0.9940563382223195, -0.9945218953682734, -0.9949685182509117, -0.9953961983671787, -0.9958049275746618, -0.9961946980917455, -0.9965655024977614, -0.996917333733128, -0.9972501850994857, -0.9975640502598242, -0.9978589232386035, -0.9981347984218669, -0.9983916705573488, -0.9986295347545738, -0.9988483864849507, -0.9990482215818578, -0.9992290362407229, -0.9993908270190957, -0.9995335908367129, -0.9996573249755573, -0.9997620270799091, -0.9998476951563913, -0.999914327574007, -0.9999619230641713, -0.9999904807207345, -1.0, -0.9999904807207345, -0.9999619230641713, -0.999914327574007, -0.9998476951563913, -0.9997620270799091, -0.9996573249755573, -0.999533590836713, -0.9993908270190958, -0.9992290362407229, -0.9990482215818578, -0.9988483864849507, -0.9986295347545738, -0.9983916705573488, -0.998134798421867, -0.9978589232386036, -0.9975640502598243, -0.9972501850994857, -0.9969173337331281, -0.9965655024977614, -0.9961946980917455, -0.9958049275746618, -0.9953961983671789, -0.9949685182509117, -0.9945218953682734, -0.9940563382223196, -0.9935718556765876, -0.9930684569549263, -0.992546151641322, -0.992004949679715, -0.9914448613738104, -0.9908658973868822, -0.9902680687415704, -0.9896513868196702, -0.9890158633619168, -0.9883615104677607, -0.9876883405951378, -0.9869963665602319, -0.9862856015372314, -0.9855560590580777, -0.9848077530122081, -0.9840406976462908, -0.9832549075639546, -0.9824503977255098, -0.9816271834476641, -0.9807852804032304, -0.9799247046208297, -0.979045472484584, -0.9781476007338058, -0.9772311064626789, -0.9762960071199335, -0.9753423205085129, -0.9743700647852352, -0.9733792584604486, -0.9723699203976768, -0.9713420698132614, -0.9702957262759966, -0.9692309097067545, -0.9681476403781077, -0.9670459389139432, -0.9659258262890682, -0.9647873238288129, -0.9636304532086231, -0.9624552364536472, -0.9612616959383188, -0.9600498543859287, -0.9588197348681932, -0.9575713608048143, -0.9563047559630354, -0.9550199444571867, -0.953716950748227, -0.9523957996432784, -0.9510565162951536, -0.9496991262018771, -0.9483236552061993, -0.9469301294951057, -0.945518575599317, -0.9440890203927844, -0.9426414910921784, -0.9411760152563707, -0.9396926207859085, -0.9381913359224844, -0.9366721892483977, -0.9351352096860118, -0.9335804264972021, -0.9320078692827986, -0.9304175679820247, -0.9288095528719241, -0.9271838545667874, -0.9255405040175665, -0.9238795325112866, -0.9222009716704518, -0.9205048534524405, -0.9187912101488982, -0.917060074385124, -0.9153114791194472, -0.9135454576426008, -0.9117620435770886, -0.9099612708765433, -0.9081431738250815, -0.9063077870366498, -0.904455145454368, -0.9025852843498607, -0.9006982393225882, -0.898794046299167, -0.8968727415326884, -0.8949343616020253, -0.892978943411137, -0.891006524188368, -0.8890171414857366, -0.887010833178222, -0.8849876374630419, -0.8829475928589271, -0.8808907382053859, -0.8788171126619658, -0.8767267557075079, -0.8746197071393961, -0.8724960070727971, -0.8703556959398998, -0.8681988144891425, -0.8660254037844386, -0.8638355052043958, -0.8616291604415255, -0.8594064115014526, -0.8571673007021123, -0.8549118706729468, -0.8526401643540921, -0.8503522249955628, -0.8480480961564261, -0.8457278217039731, -0.8433914458128857, -0.8410390129643927, -0.8386705679454243, -0.8362861558477594, -0.8338858220671682, -0.8314696123025455, -0.8290375725550421, -0.8265897491271886, -0.8241261886220158, -0.821646937942164, -0.8191520442889918, -0.816641555161679, -0.8141155183563196, -0.8115739819650127, -0.8090169943749476, -0.8064446042674829, -0.8038568606172177, -0.8012538126910608, -0.798635510047293, -0.7960020025346225, -0.7933533402912352, -0.7906895737438435, -0.7880107536067218, -0.785316930880745, -0.782608156852414, -0.7798844830928816, -0.7771459614569708, -0.7743926440821857, -0.7716245833877197, -0.7688418320734595, -0.7660444431189781, -0.7632324697825291, -0.7604059656000308, -0.7575649843840496, -0.7547095802227722, -0.7518398074789777, -0.7489557207890021, -0.7460573750616997, -0.7431448254773946, -0.740218127486832, -0.7372773368101242, -0.7343225094356858, -0.731353701619171, -0.7283709698824004, -0.7253743710122879, -0.7223639620597561, -0.7193398003386517, -0.7163019434246545, -0.7132504491541819, -0.7101853756232853, -0.7071067811865477, -0.7040147244559687, -0.7009092642998508, -0.6977904598416802, -0.6946583704589976, -0.6915130557822692, -0.688354575693754, -0.6851829903263593, -0.6819983600624983, -0.6788007455329417, -0.6755902076156605, -0.6723668074346678, -0.6691306063588581, -0.6658816660008344, -0.6626200482157378, -0.6593458151000687, -0.6560590289905074, -0.6527597524627228, -0.6494480483301841, -0.6461239796429639, -0.6427876096865396, -0.6394390019805852, -0.636078220277764, -0.6327053285625163, -0.6293203910498378, -0.6259234721840596, -0.6225146366376196, -0.6190939493098343, -0.6156614753256588, -0.6122172800344494, -0.608761429008721, -0.6052939880428949, -0.6018150231520483, -0.5983246005706593, -0.594822786751341, -0.5913096483635824, -0.5877852522924734, -0.5842496656374341, -0.5807029557109397, -0.5771451900372337, -0.5735764363510465, -0.5699967625963029, -0.5664062369248329, -0.5628049276950688, -0.5591929034707473, -0.5555702330196022, -0.5519369853120577, -0.5482932295199143, -0.544639035015027, -0.5409744713679948, -0.5372996083468242, -0.5336145159156114, -0.5299192642332058, -0.5262139236518699, -0.5224985647159487, -0.5187732581605222, -0.5150380749100545, -0.5112930860770518, -0.5075383629607049, -0.5037739770455265, -0.5000000000000004, -0.49621650367520886, -0.4924235601034673, -0.48862124149695535, -0.4848096202463369, -0.48098876891938774, -0.47715876025960874, -0.4733196671848432, -0.4694715627858908, -0.4656145203251117, -0.46174861323503363, -0.4578739151169575, -0.45399049973954697, -0.4500984410374347, -0.4461978131098095, -0.4422886902190014, -0.438371146789077, -0.4344452574044177, -0.4305110968082952, -0.4265687399014579, -0.4226182617407, -0.4186597375374281, -0.4146932426562401, -0.4107188526134778, -0.40673664307580015, -0.40274668985873824, -0.39874906892524664, -0.3947438563842671, -0.3907311284892747, -0.386710961636821, -0.38268343236508956, -0.37864861735243305, -0.37460659341591235, -0.3705574375098368, -0.36650122672429725, -0.36243803828370186, -0.35836794954530077, -0.3542910379977158, -0.35020738125946765, -0.3461170570774934, -0.3420201433256686, -0.33791671800332707, -0.3338068592337713, -0.3296906452627871, -0.32556815445715753, -0.32143946530316186, -0.31730465640509187, -0.31316380648375036, -0.3090169943749477, -0.30486429902801043, -0.30070579950427384, -0.2965415749755711, -0.29237170472273627, -0.28819626813409, -0.2840153447039227, -0.27982901403099325, -0.2756373558169998, -0.27144044986507426, -0.267238376078258, -0.26303121445797534, -0.2588190451025207, -0.2546019482055278, -0.2503800040544419, -0.24615329302899291, -0.24192189559966787, -0.2376858923261735, -0.23344536385590609, -0.22920039092241423, -0.22495105434386534, -0.2206974350215017, -0.21643961393810288, -0.21217767215644653, -0.20791169081775987, -0.2036417511401774, -0.1993679344171965, -0.19509032201612872, -0.19080899537654467, -0.18652403600873563, -0.18223552549214783, -0.17794354547384153, -0.17364817766693127, -0.16934950384902492, -0.16504760586067735, -0.16074256560382694, -0.1564344650402311, -0.15212338618991633, -0.14780941112961138, -0.14349262199117946, -0.13917310096006588, -0.13485093027372372, -0.13052619222005168, -0.12619896913583012, -0.12186934340514811, -0.11753739745783766, -0.11320321376790701, -0.10886687485196514, -0.10452846326765342, -0.1001880616120765, -0.09584575252022448, -0.09150161866340226, -0.08715574274765832, -0.08280820751220387, -0.07845909572784562, -0.0741084901953993, -0.06975647374412476, -0.06540312923014367, -0.061048539534856866, -0.05669278756337689, -0.05233595624294437, -0.04797812852134387, -0.043619387365335306, -0.039259815759069075, -0.034899496702500823, -0.03053851320982367, -0.026176948307873545, -0.0218148850345609, -0.01745240643728445, -0.013089595571344759, -0.008726535498373636, -0.004363309284747432]

// PID control modes
PID pid_angle, pid_rpm, pid_focIq, pid_focId;

// Encoder calibration
double encoder_calib_data[] = {7.91, 37.08, 66.35, 95.71, 126.4, 157.23, 187.73, 217.17, 246.35, 275.8, 306.47, 337.23};
double encoder_LUT[(int)ENCODER_RES];

// FOC
volatile float foc_id = 0, foc_iq = 0;

// Sensorless
volatile float phase_delay = 0;
volatile uint8_t current_phase = 0;
volatile bool sensorless_flag = false;
volatile uint8_t comp_rshift, bemf_dir;
volatile unsigned char comp_u, comp_v, comp_w, comparator = 0;

// Motor modes
volatile motor_mode mode = MODE_POWER;
volatile motor_waveform_type waveform_mode = MOTOR_SVPWM;

volatile float position = 0.0, rpm = 0.0, rpm_der = 0.0, power = 0.0;

float motor_zero_angle = 0.0;

void __ISR_AT_VECTOR(_TIMER_4_VECTOR, IPL6AUTO) FOC_loop(void){
	IFS0bits.T4IF = 0;
	
	LED0 = 1;
	
	static long int pos_cnt;
	pos_cnt = POS1CNT;
	
	if(pos_cnt < 0) {
		pos_cnt += ENCODER_RES;
	}
	pos_cnt &= ENCODER_RES_MASK;
	
	position = encoder_LUT[pos_cnt] - motor_zero_angle + rpm * RPM_ADVANCE_FACTOR;
//	position = ((float)pos_cnt * 360.0 / ENCODER_RES) - motor_zero_angle + rpm * RPM_ADVANCE_FACTOR;
//	position = ((float)(4095 - spi_angle) * 360.0 / 4095.0) - motor_zero_angle;
	
	if(position < 0.0) {
		position += 360.0;
	}else if(position > 360.0) {
		position -= 360.0;
	}

	foc_current_calc(position*pole_pairs);

	if(mode != MODE_OFF) {
		if(power) {
			PID_compute(&pid_focIq, foc_iq, 0.00004);
			PID_compute(&pid_focId, foc_id, 0.00004);
		} else {
			PID_reset(&pid_focIq);
			PID_reset(&pid_focId);
		}
//		setPhaseVoltage(power, 0, position*pole_pairs + power/fabs(power)*foc_degree_advance);
		setPhaseVoltage(power, 0, position*pole_pairs);
	}
	LED0 = 0;
}

#define RPM_LPF 0.95
#define RPM_DER_LPF 0.9

void __ISR_AT_VECTOR(_TIMER_6_VECTOR, IPL4AUTO) RPM(void){
	IFS2bits.T6IF = 0;
	static volatile long int temp = 0, p_temp;
	static volatile float p_rpm = 0.0;

	static long int ind_cnt;
	static float net_position;
	
	p_temp = temp;
	temp = VEL1CNT;
	
	p_rpm = rpm;
	rpm = (1.0-RPM_LPF) * ((float)temp / ENCODER_RES * 30000.0) + RPM_LPF*rpm;
	
	//rpm_der = (1.0-RPM_LPF) * ((float)(temp-p_temp) / ENCODER_RES * 60000.0) + RPM_LPF*rpm_der;    
	rpm_der = (1.0-RPM_DER_LPF)*(rpm-p_rpm) + RPM_DER_LPF*rpm_der;
	
	// RPM PID control
	if(mode == MODE_RPM) {        
		PID_compute(&pid_angle, net_position, 0.002);

		if(pid_rpm.setpoint == 0 && fabs(rpm) < 25) {
			power = 0;
		} else {
			power = pid_rpm.output;
		}
		
	// Angle PID control
	} else if (mode == MODE_POS) {
		ind_cnt = INDX1CNT;
		net_position = position + ind_cnt * 360.0;

		power = PID_compute(&pid_angle, net_position, 0.002) / 2000.0;
	}
}

void setPhaseVoltage(float p, float p_d, float angle_el) {
	float pwm_u, pwm_v, pwm_w;
	float s, c;

	float center;
	float Ud, Uq;
	float Ualpha, Ubeta;
	float pwm_min, pwm_max;

	float offset = 0;

	static float *PWM_table;
	int index;

	p = p < -1.0 ? -1.0 : p > 1.0 ? 1.0 : p;
	
	if(waveform_mode == MOTOR_FOC) {
//		p = fabs(p);
		p *= (float)PWM_MAX/2 ;
		angle_el = normalizeAngle(angle_el);
		
		index = angle_el * 4;
		index = index < 0.0 | index >= LUT_SIZE ? 0 : index;
		s = sin_lut[index];
		index = (index + LUT_SIZE/4) % LUT_SIZE;
		c = sin_lut[index];

		Uq = p;//-pid_focIq.output;
		Ud = 0;//pid_focId.output;

		// Inverse Park Transform
		Ualpha = c * Ud - s * Uq;
		Ubeta = s * Ud + c * Uq;

		// Inverse Clarke Transform
		pwm_u = Ualpha;
		pwm_v = -0.5f * Ualpha - _SQRT3_2 * Ubeta;
		pwm_w = -0.5f * Ualpha + _SQRT3_2 * Ubeta;

		center = PWM_MAX/2;
		
		// SVPWM
		pwm_min = fmin(pwm_u, fmin(pwm_v, pwm_w));
		pwm_max = fmax(pwm_u, fmax(pwm_v, pwm_w));
		center -= (pwm_max+pwm_min) / 2;

		pwm_u += center;
		pwm_v += center;
		pwm_w += center;

//		pwm_u -= pwm_min;
//		pwm_v -= pwm_min;
//		pwm_w -= pwm_min;
		
	} else if(waveform_mode == MOTOR_SIN || waveform_mode == MOTOR_SVPWM) {

		// if(p < 0) angle_el += 180;
		p = fabs(p);
		p *= (float)PWM_MAX;
		angle_el = normalizeAngle(angle_el);
		
		if(waveform_mode == MOTOR_SIN) {
			PWM_table = SIN_table;
			p /= 2;
			offset = 0.5;
		} else if(waveform_mode == MOTOR_SVPWM){
			PWM_table = SVPWM_table;
			offset = 0;
		}
		
		index = angle_el * 4;
		index = index < 0.0 | index >= LUT_SIZE ? 0 : index;
		
		pwm_u = ((float)PWM_table[index] + offset) * p;
		
		index = (index + LUT_120_SHIFT) % LUT_SIZE;
		pwm_v = ((float)PWM_table[index] + offset) * p;
		
		index = (index + LUT_120_SHIFT) % LUT_SIZE;
		pwm_w = ((float)PWM_table[index] + offset) * p;
		
	} else if(waveform_mode == MOTOR_TRAPEZOID) {
		p = fabs(p);
		angle_el = normalizeAngle(angle_el);
		angle_el = round(angle_el / 60);
		MotorPhase((signed char)angle_el, p);
	}

	if(waveform_mode != MOTOR_TRAPEZOID) {
		// Clamp PWM to [0, PWM_MAX - DEAD_TIME]
		pwm_u = pwm_u > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_u < 0 ? 0: pwm_u;
		pwm_v = pwm_v > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_v < 0 ? 0: pwm_v;
		pwm_w = pwm_w > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_w < 0 ? 0: pwm_w;
		
		if(pwm_u) {
			PDC1 = pwm_u;
			PDC7 = pwm_u + DEAD_TIME;
		} else {
			PDC1 = pwm_u;
			PDC7 = pwm_u;
		}
		
		if(pwm_v) {
			PDC2 = pwm_v;
			PDC8 = pwm_v + DEAD_TIME;
		} else {
			PDC2 = pwm_v;
			PDC8 = pwm_v ;
		}

		if(pwm_w) {
			PDC3 = pwm_w;
			PDC9 = pwm_w + DEAD_TIME;
		} else {
			PDC3 = pwm_w;
			PDC9 = pwm_w;
		}
	}
}

#define FOC_IQ_LPF 0.999f
void foc_current_calc(float angle_el) {
	float s, c;
	uint16_t angle_index;
	float i_alpha, i_beta;
	float isns_u, isns_v, isns_w;

	angle_index = (int)(normalizeAngle(angle_el) * 4) % LUT_SIZE;
	s = sin_lut[angle_index];
	angle_index = (angle_index + LUT_SIZE/4) % LUT_SIZE;
	c = sin_lut[angle_index];

	// Get phase current readings from ADC
	isns_u = ((float)adc_buffer[1][0][0] * ADC_CONV_FACTOR - isns_u_offset) / 20.0f / ISNS_UVW_R;
	isns_v = ((float)adc_buffer[4][0][0] * ADC_CONV_FACTOR - isns_v_offset) / 20.0f / ISNS_UVW_R;
	isns_w = -(isns_u + isns_v);

	// Clarke Transform
	i_alpha = isns_u;
	i_beta = _1_SQRT3 * isns_u + _2_SQRT3 * isns_w;

	// Park Transform
	foc_iq = FOC_IQ_LPF*foc_iq + (1.0-FOC_IQ_LPF) * (-i_alpha* s + i_beta* c);
	foc_id = FOC_IQ_LPF*foc_id + (1.0-FOC_IQ_LPF) * (i_alpha* c + i_beta* s);
}


/*---------------------------------------------------------------------
 |                            Sensorless                              |
 ----------------------------------------------------------------------*/

void SensorlessStart(float p) {
	sensorless_flag = false;
	power = p;
	current_phase = 0;
	waveform_mode = MODE_SENSORLESS;
	
	comp_rshift = 0;
	bemf_dir = 1;
	
	IEC5bits.PWM4IE = 0;
	
	TMR8 = 0;
	PR8 = 3600;
	T8CONbits.ON = 1;
}

void __ISR(_TIMER_8_VECTOR, IPL7SOFT) Sensorless_timer(void) {
	IFS2bits.T8IF = 0;
	
	LATDINV |= 1 << 6;
	PR8 = 0xFFFFFFFF;
	T8CONbits.ON = 0;
	
//	if(sensorless_flag) {
//		sensorless_flag = false;
//		current_phase = (current_phase + 1) % 6;
//		MotorPhase(current_phase, power);
//		TMR8 = 0;
//		PR8 = 3600;
//	
//	} else {
//		IEC5bits.PWM4IE = 1;
//		PR8 = 0xFFFFFFFF;
//		TMR8 = 3600;
//	}
}

volatile bool bemf_flag;
volatile uint8_t pwm_odd = 0;
void __ISR(_PWM4_VECTOR, IPL7AUTO) PWM_sync_timer(void) {
//    PWMCON4bits.TRGIF = 0;
	PWMCON4bits.PWMHIF = 0;
	IFS5bits.PWM4IF = 0;
	
	if(pwm_odd == 1) {
		comparator = (PORTG >> 6) & 0b111;
		comp_u = (comparator >> 2) & 1;
		comp_v = (comparator >> 1) & 1;
		comp_w = comparator & 1;

//		LATDINV |= 1 << 6;
	
//		TMR8 = 0;
//		PR8 = 10;
//		T8CONbits.ON = 1;
	
//		if(waveform_mode == MODE_SENSORLESS) {
//			if(current_phase == 0) {
//				if(comparator & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 1) {
//				if(!((comparator >> 1) & 1)) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 2) {
//				if((comparator >> 2) & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 3) {
//				if(!(comparator & 1)) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 4) {
//				if((comparator >> 1) & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 5) {
//				if(!((comparator >> 2) & 1)) {
//					bemf_flag = true;
//				}
//			}
//			if(bemf_flag) {
//				IEC5bits.PWM4IE = 0;
//				sensorless_flag = true;
//				phase_delay = (1.0f-LPF_PHASE)*phase_delay + LPF_PHASE*(float)TMR8;
//				TMR8 = 0;
//				PR8 = phase_delay;
//			}
//		}
	}
	
	pwm_odd = (pwm_odd + 1) % 2;
}

void MotorPhase(signed char num, float val) {
	val = val * (float)PWM_MAX;
	num = num % 6;
	if(num < 0) {
		num += 6;
	}
	switch(num) {
		case 0:
			// W - NC
			PDC1 = 0;
			PDC7 = PWM_MAX;
			// V - V+
			PDC2 = val;
			PDC8 = val;
			// U - GND
			PDC3 = 0;
			PDC9 = 0;
			break;
		case 1:
			// W - V+
			PDC1 = val;
			PDC7 = val;
			// V - NC
			PDC2 = 0;
			PDC8 = PWM_MAX;
			// U - GND
			PDC3 = 0;
			PDC9 = 0;
			break;
		case 2:
			// W - V+
			PDC1 = val;
			PDC7 = val;
			// V - GND
			PDC2 = 0;
			PDC8 = 0;
			// U - NC
			PDC3 = 0;
			PDC9 = PWM_MAX;
			break;
		case 3:
			// W - NC
			PDC1 = 0;
			PDC7 = PWM_MAX;
			// V - GND
			PDC2 = 0;
			PDC8 = 0;
			// U - V+
			PDC3 = val;
			PDC9 = val;
			break;
		case 4:
			// W - GND
			PDC1 = 0;
			PDC7 = 0;
			// V - NC
			PDC2 = 0;
			PDC8 = PWM_MAX;
			// U - V+
			PDC3 = val;
			PDC9 = val;
			break;
		case 5:
			// W - GND
			PDC1 = 0;
			PDC7 = 0;
			// V - V+
			PDC2 = val;
			PDC8 = val;
			// U - NC
			PDC3 = 0;
			PDC9 = PWM_MAX;
			break;       
	}
}

bool bemf_phase(unsigned char phase) {
	phase = phase % 6;
	if(phase == 0) {
		return comp_w;
	} else if(phase == 1) {
		return !comp_v;
	} else if(phase == 2) {
		return comp_u;
	} else if(phase == 3) {
		return !comp_w;
	} else if(phase == 4) {
		return comp_v;
	} else if(phase == 5) {
		return !comp_u;
	}
	return false;
}

/*---------------------------------------------------------------------
 |                                PID                                 |
 ----------------------------------------------------------------------*/

void MotorPIDInit() {
	PID_init(&pid_angle);
	PID_init(&pid_rpm);
	PID_init(&pid_focIq);
	PID_init(&pid_focId);

	PID_setGain(&pid_angle,	8,		1.25,	6		);
	PID_setGain(&pid_rpm,	0.0002,	0.005,	0.008	);
	PID_setGain(&pid_focIq,	100,	100,	0		);
	PID_setGain(&pid_focId,	20,		20,		0		);

	PID_setLPF(&pid_angle,	0.8);
	PID_setLPF(&pid_rpm,	0.8);

	PID_enableIntegralConstrain(&pid_angle);
	PID_setOutputLimits(&pid_angle,	-250,	250);

	PID_enableErrorConstrain(&pid_rpm);
	PID_setErrorLimits(&pid_rpm,	-500,	500);

	PID_enableErrorConstrain(&pid_focIq);
	PID_setErrorLimits(&pid_focIq, -1, 1);
	PID_enableOutputConstrain(&pid_focIq);
	PID_setOutputLimits(&pid_focIq, -1000, 1000);
	
	PID_enableErrorConstrain(&pid_focId);
	PID_setErrorLimits(&pid_focId, -1, 1);
	PID_enableIntegralConstrain(&pid_focId);
	PID_setOutputLimits(&pid_focId, -1000, 1000);
}

void ResetMotorPID() {
	PID_reset(&pid_angle);
	PID_reset(&pid_rpm);
}

void SetPower(float p) {
	power = p;
}

void SetRPM(float rpm) {
	pid_rpm.setpoint = rpm;
}

void SetPosition(float pos) {
	pid_angle.setpoint = pos;
}

float GetPosition() {
	return position;
}

float GetPower() {
	return power;
}

void ResetPosition() {
	unsigned long int t = VEL1CNT;
	INDX1CNT = 0;
	position = 0.0;
}

float GetRPM() {
	return rpm;
}

float GetRPM_der() {
	return rpm_der;
}

float normalizeAngle(float angle) {
	float a = fmod(angle, 360.0f);
	return a >= 0 ? a : (a + 360.0f);
}

void MotorOff() {
	power = 0;
	// A - NC
	PDC1 = 0;
	PDC7 = PWM_MAX;
	// B - NC
	PDC2 = 0;
	PDC8 = PWM_MAX;
	// C - NC
	PDC3 = 0;
	PDC9 = PWM_MAX;
}

void MotorShort(float p) {
	p *= PWM_MAX;

	PDC1 = 0;
	PDC7 = p;

	PDC2 = 0;
	PDC8 = p;

	PDC3 = 0;
	PDC9 = p;
}

void init_encoder_lut() {
	unsigned int i;
	for(i = 0; i < ENCODER_RES; i++) {
		encoder_LUT[i] = (double)i * 360.0/(double)ENCODER_RES;
	}
}

void interpolate_encoder_lut(double in[], unsigned int len) {
	int i, j, k;
	double delta;
	double arr[(int)pole_pairs*6][2];
	
	for(i = 0; i < len; i++) {
		arr[i][0] = in[i] * ENCODER_RES / 360.0;
		arr[i][1] = (double)i / len * ENCODER_RES;
	}
	
	for(i = 0; i < ENCODER_RES; i++) {
		for(j = 0; j < len; j++) {
			k = (j + 1) % len;
			if(i >= arr[j][0] && i < arr[k][0]) {
				delta = i - arr[j][0];
				delta = delta / (arr[k][0] - arr[j][0]) * ENCODER_RES / len;//(arr[k][1] - arr[j][1]);
				break;
			} else if((fabs(arr[k][0] - arr[j][0]) > ENCODER_RES/2) && (i > arr[j][0] || i < arr[k][0])) {
				delta = i - arr[j][0];
				if(delta > ENCODER_RES/2) {
					delta -= ENCODER_RES;
				} else if(delta < -ENCODER_RES/2) {
					delta += ENCODER_RES;
				}
				delta = delta / (arr[k][0] - arr[j][0] + ENCODER_RES) * ENCODER_RES / len;// * (arr[k][1] - arr[j][1]);
				break;
			}
		}
		encoder_LUT[i] = fmod(arr[j][1] + delta, ENCODER_RES) * 360.0 / ENCODER_RES;
	}
}
