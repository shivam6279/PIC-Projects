#include "BLDC.h"
#include "PWM.h"
#include <xc.h>
#include <stdbool.h>
#include <inttypes.h>
#include <sys/attribs.h>
#include <math.h>
#include "USART.h"
#include "SPI.h"
#include "ADC.h"
#include "pic32.h"
#include "PID.h"

#define _SQRT3_2 0.86602540378443864676372317075294
#define _1_SQRT3 0.57735026918962576450914878050196
#define _2_SQRT3 1.1547005383792515290182975610039

#define DEAD_TIME 25

float pole_pairs = POLE_PAIRS;
float foc_degree_advance = FOC_DEGREE_ADVANCE;

// SVPWM
float svpwm_max = 1000;
float SVPWM_table[SVPWM_SIZE] = {500.0000, 503.7787, 507.5574, 511.3359, 515.1142, 518.8922, 522.6699, 526.4471, 530.2239, 534.0000, 537.7755, 541.5503, 545.3243, 549.0974, 552.8696, 556.6408, 560.4109, 564.1798, 567.9476, 571.7140, 575.4791, 579.2427, 583.0049, 586.7654, 590.5243, 594.2815, 598.0369, 601.7904, 605.5419, 609.2915, 613.0390, 616.7843, 620.5274, 624.2683, 628.0067, 631.7427, 635.4762, 639.2071, 642.9354, 646.6610, 650.3837, 654.1036, 657.8206, 661.5346, 665.2454, 668.9532, 672.6577, 676.3589, 680.0568, 683.7513, 687.4422, 691.1296, 694.8133, 698.4934, 702.1696, 705.8420, 709.5105, 713.1750, 716.8354, 720.4918, 724.1439, 727.7917, 731.4352, 735.0743, 738.7090, 742.3390, 745.9645, 749.5853, 753.2013, 756.8125, 760.4189, 764.0202, 767.6166, 771.2078, 774.7939, 778.3747, 781.9503, 785.5205, 789.0852, 792.6445, 796.1981, 799.7462, 803.2885, 806.8250, 810.3557, 813.8805, 817.3994, 820.9122, 824.4188, 827.9193, 831.4136, 834.9015, 838.3831, 841.8582, 845.3268, 848.7889, 852.2443, 855.6930, 859.1349, 862.5700, 865.9982, 869.4194, 872.8335, 876.2406, 879.6405, 883.0332, 886.4186, 889.7967, 893.1673, 896.5304, 899.8860, 903.2340, 906.5743, 909.9069, 913.2316, 916.5485, 919.8574, 923.1584, 926.4513, 929.7361, 933.0127, 934.0994, 935.1778, 936.2480, 937.3099, 938.3634, 939.4086, 940.4454, 941.4738, 942.4938, 943.5054, 944.5086, 945.5033, 946.4895, 947.4672, 948.4364, 949.3970, 950.3491, 951.2926, 952.2276, 953.1539, 954.0716, 954.9806, 955.8810, 956.7727, 957.6557, 958.5300, 959.3956, 960.2524, 961.1005, 961.9398, 962.7703, 963.5919, 964.4048, 965.2088, 966.0039, 966.7902, 967.5676, 968.3361, 969.0957, 969.8463, 970.5880, 971.3207, 972.0445, 972.7593, 973.4651, 974.1618, 974.8496, 975.5283, 976.1979, 976.8585, 977.5100, 978.1524, 978.7857, 979.4099, 980.0249, 980.6308, 981.2276, 981.8152, 982.3937, 982.9629, 983.5230, 984.0738, 984.6155, 985.1479, 985.6710, 986.1850, 986.6896, 987.1850, 987.6712, 988.1480, 988.6156, 989.0738, 989.5227, 989.9624, 990.3926, 990.8136, 991.2252, 991.6275, 992.0203, 992.4039, 992.7780, 993.1428, 993.4982, 993.8442, 994.1808, 994.5079, 994.8257, 995.1340, 995.4329, 995.7224, 996.0025, 996.2731, 996.5342, 996.7859, 997.0282, 997.2609, 997.4843, 997.6981, 997.9025, 998.0973, 998.2828, 998.4587, 998.6251, 998.7820, 998.9295, 999.0674, 999.1958, 999.3148, 999.4242, 999.5241, 999.6145, 999.6954, 999.7668, 999.8287, 999.8810, 999.9238, 999.9572, 999.9810, 999.9952, 1000.0000, 999.9952, 999.9810, 999.9572, 999.9238, 999.8810, 999.8287, 999.7668, 999.6954, 999.6145, 999.5241, 999.4242, 999.3148, 999.1958, 999.0674, 998.9295, 998.7820, 998.6251, 998.4587, 998.2828, 998.0973, 997.9025, 997.6981, 997.4843, 997.2609, 997.0282, 996.7859, 996.5342, 996.2731, 996.0025, 995.7224, 995.4329, 995.1340, 994.8257, 994.5079, 994.1808, 993.8442, 993.4982, 993.1428, 992.7780, 992.4039, 992.0203, 991.6275, 991.2252, 990.8136, 990.3926, 989.9624, 989.5227, 989.0738, 988.6156, 988.1480, 987.6712, 987.1850, 986.6896, 986.1850, 985.6710, 985.1479, 984.6155, 984.0738, 983.5230, 982.9629, 982.3937, 981.8152, 981.2276, 980.6308, 980.0249, 979.4099, 978.7857, 978.1524, 977.5100, 976.8585, 976.1979, 975.5283, 974.8496, 974.1618, 973.4651, 972.7593, 972.0445, 971.3207, 970.5880, 969.8463, 969.0957, 968.3361, 967.5676, 966.7902, 966.0039, 965.2088, 964.4048, 963.5919, 962.7703, 961.9398, 961.1005, 960.2524, 959.3956, 958.5300, 957.6557, 956.7727, 955.8810, 954.9806, 954.0716, 953.1539, 952.2276, 951.2926, 950.3491, 949.3970, 948.4364, 947.4672, 946.4895, 945.5033, 944.5086, 943.5054, 942.4938, 941.4738, 940.4454, 939.4086, 938.3634, 937.3099, 936.2480, 935.1778, 934.0994, 933.0127, 934.0994, 935.1778, 936.2480, 937.3099, 938.3634, 939.4086, 940.4454, 941.4738, 942.4938, 943.5054, 944.5086, 945.5033, 946.4895, 947.4672, 948.4364, 949.3970, 950.3491, 951.2926, 952.2276, 953.1539, 954.0716, 954.9806, 955.8810, 956.7727, 957.6557, 958.5300, 959.3956, 960.2524, 961.1005, 961.9398, 962.7703, 963.5919, 964.4048, 965.2088, 966.0039, 966.7902, 967.5676, 968.3361, 969.0957, 969.8463, 970.5880, 971.3207, 972.0445, 972.7593, 973.4651, 974.1618, 974.8496, 975.5283, 976.1979, 976.8585, 977.5100, 978.1524, 978.7857, 979.4099, 980.0249, 980.6308, 981.2276, 981.8152, 982.3937, 982.9629, 983.5230, 984.0738, 984.6155, 985.1479, 985.6710, 986.1850, 986.6896, 987.1850, 987.6712, 988.1480, 988.6156, 989.0738, 989.5227, 989.9624, 990.3926, 990.8136, 991.2252, 991.6275, 992.0203, 992.4039, 992.7780, 993.1428, 993.4982, 993.8442, 994.1808, 994.5079, 994.8257, 995.1340, 995.4329, 995.7224, 996.0025, 996.2731, 996.5342, 996.7859, 997.0282, 997.2609, 997.4843, 997.6981, 997.9025, 998.0973, 998.2828, 998.4587, 998.6251, 998.7820, 998.9295, 999.0674, 999.1958, 999.3148, 999.4242, 999.5241, 999.6145, 999.6954, 999.7668, 999.8287, 999.8810, 999.9238, 999.9572, 999.9810, 999.9952, 1000.0000, 999.9952, 999.9810, 999.9572, 999.9238, 999.8810, 999.8287, 999.7668, 999.6954, 999.6145, 999.5241, 999.4242, 999.3148, 999.1958, 999.0674, 998.9295, 998.7820, 998.6251, 998.4587, 998.2828, 998.0973, 997.9025, 997.6981, 997.4843, 997.2609, 997.0282, 996.7859, 996.5342, 996.2731, 996.0025, 995.7224, 995.4329, 995.1340, 994.8257, 994.5079, 994.1808, 993.8442, 993.4982, 993.1428, 992.7780, 992.4039, 992.0203, 991.6275, 991.2252, 990.8136, 990.3926, 989.9624, 989.5227, 989.0738, 988.6156, 988.1480, 987.6712, 987.1850, 986.6896, 986.1850, 985.6710, 985.1479, 984.6155, 984.0738, 983.5230, 982.9629, 982.3937, 981.8152, 981.2276, 980.6308, 980.0249, 979.4099, 978.7857, 978.1524, 977.5100, 976.8585, 976.1979, 975.5283, 974.8496, 974.1618, 973.4651, 972.7593, 972.0445, 971.3207, 970.5880, 969.8463, 969.0957, 968.3361, 967.5676, 966.7902, 966.0039, 965.2088, 964.4048, 963.5919, 962.7703, 961.9398, 961.1005, 960.2524, 959.3956, 958.5300, 957.6557, 956.7727, 955.8810, 954.9806, 954.0716, 953.1539, 952.2276, 951.2926, 950.3491, 949.3970, 948.4364, 947.4672, 946.4895, 945.5033, 944.5086, 943.5054, 942.4938, 941.4738, 940.4454, 939.4086, 938.3634, 937.3099, 936.2480, 935.1778, 934.0994, 933.0127, 929.7361, 926.4513, 923.1584, 919.8574, 916.5485, 913.2316, 909.9069, 906.5743, 903.2340, 899.8860, 896.5304, 893.1673, 889.7967, 886.4186, 883.0332, 879.6405, 876.2406, 872.8335, 869.4194, 865.9982, 862.5700, 859.1349, 855.6930, 852.2443, 848.7889, 845.3268, 841.8582, 838.3831, 834.9015, 831.4136, 827.9193, 824.4188, 820.9122, 817.3994, 813.8805, 810.3557, 806.8250, 803.2885, 799.7462, 796.1981, 792.6445, 789.0852, 785.5205, 781.9503, 778.3747, 774.7939, 771.2078, 767.6166, 764.0202, 760.4189, 756.8125, 753.2013, 749.5853, 745.9645, 742.3390, 738.7090, 735.0743, 731.4352, 727.7917, 724.1439, 720.4918, 716.8354, 713.1750, 709.5105, 705.8420, 702.1696, 698.4934, 694.8133, 691.1296, 687.4422, 683.7513, 680.0568, 676.3589, 672.6577, 668.9532, 665.2454, 661.5346, 657.8206, 654.1036, 650.3837, 646.6610, 642.9354, 639.2071, 635.4762, 631.7427, 628.0067, 624.2683, 620.5274, 616.7843, 613.0390, 609.2915, 605.5419, 601.7904, 598.0369, 594.2815, 590.5243, 586.7654, 583.0049, 579.2427, 575.4791, 571.7140, 567.9476, 564.1798, 560.4109, 556.6408, 552.8696, 549.0974, 545.3243, 541.5503, 537.7755, 534.0000, 530.2239, 526.4471, 522.6699, 518.8922, 515.1142, 511.3359, 507.5574, 503.7787, 500.0000, 496.2213, 492.4426, 488.6641, 484.8858, 481.1078, 477.3301, 473.5529, 469.7761, 466.0000, 462.2245, 458.4497, 454.6757, 450.9026, 447.1304, 443.3592, 439.5891, 435.8202, 432.0524, 428.2860, 424.5209, 420.7573, 416.9951, 413.2346, 409.4757, 405.7185, 401.9631, 398.2096, 394.4581, 390.7085, 386.9610, 383.2157, 379.4726, 375.7317, 371.9933, 368.2573, 364.5238, 360.7929, 357.0646, 353.3390, 349.6163, 345.8964, 342.1794, 338.4654, 334.7546, 331.0468, 327.3423, 323.6411, 319.9432, 316.2487, 312.5578, 308.8704, 305.1867, 301.5066, 297.8304, 294.1580, 290.4895, 286.8250, 283.1646, 279.5082, 275.8561, 272.2083, 268.5648, 264.9257, 261.2910, 257.6610, 254.0355, 250.4147, 246.7987, 243.1875, 239.5811, 235.9798, 232.3834, 228.7922, 225.2061, 221.6253, 218.0497, 214.4795, 210.9148, 207.3555, 203.8019, 200.2538, 196.7115, 193.1750, 189.6443, 186.1195, 182.6006, 179.0878, 175.5812, 172.0807, 168.5864, 165.0985, 161.6169, 158.1418, 154.6732, 151.2111, 147.7557, 144.3070, 140.8651, 137.4300, 134.0018, 130.5806, 127.1665, 123.7594, 120.3595, 116.9668, 113.5814, 110.2033, 106.8327, 103.4696, 100.1140, 96.7660, 93.4257, 90.0931, 86.7684, 83.4515, 80.1426, 76.8416, 73.5487, 70.2639, 66.9873, 65.9006, 64.8222, 63.7520, 62.6901, 61.6366, 60.5914, 59.5546, 58.5262, 57.5062, 56.4946, 55.4914, 54.4967, 53.5105, 52.5328, 51.5636, 50.6030, 49.6509, 48.7074, 47.7724, 46.8461, 45.9284, 45.0194, 44.1190, 43.2273, 42.3443, 41.4700, 40.6044, 39.7476, 38.8995, 38.0602, 37.2297, 36.4081, 35.5952, 34.7912, 33.9961, 33.2098, 32.4324, 31.6639, 30.9043, 30.1537, 29.4120, 28.6793, 27.9555, 27.2407, 26.5349, 25.8382, 25.1504, 24.4717, 23.8021, 23.1415, 22.4900, 21.8476, 21.2143, 20.5901, 19.9751, 19.3692, 18.7724, 18.1848, 17.6063, 17.0371, 16.4770, 15.9262, 15.3845, 14.8521, 14.3290, 13.8150, 13.3104, 12.8150, 12.3288, 11.8520, 11.3844, 10.9262, 10.4773, 10.0376, 9.6074, 9.1864, 8.7748, 8.3725, 7.9797, 7.5961, 7.2220, 6.8572, 6.5018, 6.1558, 5.8192, 5.4921, 5.1743, 4.8660, 4.5671, 4.2776, 3.9975, 3.7269, 3.4658, 3.2141, 2.9718, 2.7391, 2.5157, 2.3019, 2.0975, 1.9027, 1.7172, 1.5413, 1.3749, 1.2180, 1.0705, 0.9326, 0.8042, 0.6852, 0.5758, 0.4759, 0.3855, 0.3046, 0.2332, 0.1713, 0.1190, 0.0762, 0.0428, 0.0190, 0.0048, 0.0000, 0.0048, 0.0190, 0.0428, 0.0762, 0.1190, 0.1713, 0.2332, 0.3046, 0.3855, 0.4759, 0.5758, 0.6852, 0.8042, 0.9326, 1.0705, 1.2180, 1.3749, 1.5413, 1.7172, 1.9027, 2.0975, 2.3019, 2.5157, 2.7391, 2.9718, 3.2141, 3.4658, 3.7269, 3.9975, 4.2776, 4.5671, 4.8660, 5.1743, 5.4921, 5.8192, 6.1558, 6.5018, 6.8572, 7.2220, 7.5961, 7.9797, 8.3725, 8.7748, 9.1864, 9.6074, 10.0376, 10.4773, 10.9262, 11.3844, 11.8520, 12.3288, 12.8150, 13.3104, 13.8150, 14.3290, 14.8521, 15.3845, 15.9262, 16.4770, 17.0371, 17.6063, 18.1848, 18.7724, 19.3692, 19.9751, 20.5901, 21.2143, 21.8476, 22.4900, 23.1415, 23.8021, 24.4717, 25.1504, 25.8382, 26.5349, 27.2407, 27.9555, 28.6793, 29.4120, 30.1537, 30.9043, 31.6639, 32.4324, 33.2098, 33.9961, 34.7912, 35.5952, 36.4081, 37.2297, 38.0602, 38.8995, 39.7476, 40.6044, 41.4700, 42.3443, 43.2273, 44.1190, 45.0194, 45.9284, 46.8461, 47.7724, 48.7074, 49.6509, 50.6030, 51.5636, 52.5328, 53.5105, 54.4967, 55.4914, 56.4946, 57.5062, 58.5262, 59.5546, 60.5914, 61.6366, 62.6901, 63.7520, 64.8222, 65.9006, 66.9873, 65.9006, 64.8222, 63.7520, 62.6901, 61.6366, 60.5914, 59.5546, 58.5262, 57.5062, 56.4946, 55.4914, 54.4967, 53.5105, 52.5328, 51.5636, 50.6030, 49.6509, 48.7074, 47.7724, 46.8461, 45.9284, 45.0194, 44.1190, 43.2273, 42.3443, 41.4700, 40.6044, 39.7476, 38.8995, 38.0602, 37.2297, 36.4081, 35.5952, 34.7912, 33.9961, 33.2098, 32.4324, 31.6639, 30.9043, 30.1537, 29.4120, 28.6793, 27.9555, 27.2407, 26.5349, 25.8382, 25.1504, 24.4717, 23.8021, 23.1415, 22.4900, 21.8476, 21.2143, 20.5901, 19.9751, 19.3692, 18.7724, 18.1848, 17.6063, 17.0371, 16.4770, 15.9262, 15.3845, 14.8521, 14.3290, 13.8150, 13.3104, 12.8150, 12.3288, 11.8520, 11.3844, 10.9262, 10.4773, 10.0376, 9.6074, 9.1864, 8.7748, 8.3725, 7.9797, 7.5961, 7.2220, 6.8572, 6.5018, 6.1558, 5.8192, 5.4921, 5.1743, 4.8660, 4.5671, 4.2776, 3.9975, 3.7269, 3.4658, 3.2141, 2.9718, 2.7391, 2.5157, 2.3019, 2.0975, 1.9027, 1.7172, 1.5413, 1.3749, 1.2180, 1.0705, 0.9326, 0.8042, 0.6852, 0.5758, 0.4759, 0.3855, 0.3046, 0.2332, 0.1713, 0.1190, 0.0762, 0.0428, 0.0190, 0.0048, 0.0000, 0.0048, 0.0190, 0.0428, 0.0762, 0.1190, 0.1713, 0.2332, 0.3046, 0.3855, 0.4759, 0.5758, 0.6852, 0.8042, 0.9326, 1.0705, 1.2180, 1.3749, 1.5413, 1.7172, 1.9027, 2.0975, 2.3019, 2.5157, 2.7391, 2.9718, 3.2141, 3.4658, 3.7269, 3.9975, 4.2776, 4.5671, 4.8660, 5.1743, 5.4921, 5.8192, 6.1558, 6.5018, 6.8572, 7.2220, 7.5961, 7.9797, 8.3725, 8.7748, 9.1864, 9.6074, 10.0376, 10.4773, 10.9262, 11.3844, 11.8520, 12.3288, 12.8150, 13.3104, 13.8150, 14.3290, 14.8521, 15.3845, 15.9262, 16.4770, 17.0371, 17.6063, 18.1848, 18.7724, 19.3692, 19.9751, 20.5901, 21.2143, 21.8476, 22.4900, 23.1415, 23.8021, 24.4717, 25.1504, 25.8382, 26.5349, 27.2407, 27.9555, 28.6793, 29.4120, 30.1537, 30.9043, 31.6639, 32.4324, 33.2098, 33.9961, 34.7912, 35.5952, 36.4081, 37.2297, 38.0602, 38.8995, 39.7476, 40.6044, 41.4700, 42.3443, 43.2273, 44.1190, 45.0194, 45.9284, 46.8461, 47.7724, 48.7074, 49.6509, 50.6030, 51.5636, 52.5328, 53.5105, 54.4967, 55.4914, 56.4946, 57.5062, 58.5262, 59.5546, 60.5914, 61.6366, 62.6901, 63.7520, 64.8222, 65.9006, 66.9873, 70.2639, 73.5487, 76.8416, 80.1426, 83.4515, 86.7684, 90.0931, 93.4257, 96.7660, 100.1140, 103.4696, 106.8327, 110.2033, 113.5814, 116.9668, 120.3595, 123.7594, 127.1665, 130.5806, 134.0018, 137.4300, 140.8651, 144.3070, 147.7557, 151.2111, 154.6732, 158.1418, 161.6169, 165.0985, 168.5864, 172.0807, 175.5812, 179.0878, 182.6006, 186.1195, 189.6443, 193.1750, 196.7115, 200.2538, 203.8019, 207.3555, 210.9148, 214.4795, 218.0497, 221.6253, 225.2061, 228.7922, 232.3834, 235.9798, 239.5811, 243.1875, 246.7987, 250.4147, 254.0355, 257.6610, 261.2910, 264.9257, 268.5648, 272.2083, 275.8561, 279.5082, 283.1646, 286.8250, 290.4895, 294.1580, 297.8304, 301.5066, 305.1867, 308.8704, 312.5578, 316.2487, 319.9432, 323.6411, 327.3423, 331.0468, 334.7546, 338.4654, 342.1794, 345.8964, 349.6163, 353.3390, 357.0646, 360.7929, 364.5238, 368.2573, 371.9933, 375.7317, 379.4726, 383.2157, 386.9610, 390.7085, 394.4581, 398.2096, 401.9631, 405.7185, 409.4757, 413.2346, 416.9951, 420.7573, 424.5209, 428.2860, 432.0524, 435.8202, 439.5891, 443.3592, 447.1304, 450.9026, 454.6757, 458.4497, 462.2245, 466.0000, 469.7761, 473.5529, 477.3301, 481.1078, 484.8858, 488.6641, 492.4426, 496.2213};
float SIN_table[SVPWM_SIZE] = {500, 502.1816546, 504.3632677, 506.5447978, 508.7262032, 510.9074425, 513.0884742, 515.2692566, 517.4497484, 519.6299079, 521.8096937, 523.9890643, 526.1679781, 528.3463938, 530.5242698, 532.7015646, 534.8782369, 537.0542451, 539.2295479, 541.4041038, 543.5778714, 545.7508093, 547.9228763, 550.0940308, 552.2642316, 554.4334374, 556.6016069, 558.7686987, 560.9346717, 563.0994846, 565.2630961, 567.4254651, 569.5865505, 571.746311, 573.9047056, 576.0616931, 578.2172325, 580.3712828, 582.5238029, 584.6747519, 586.8240888, 588.9717727, 591.1177627, 593.262018, 595.4044977, 597.545161, 599.6839672, 601.8208756, 603.9558454, 606.0888361, 608.219807, 610.3487175, 612.4755272, 614.6001955, 616.7226819, 618.8429462, 620.9609478, 623.0766465, 625.190002, 627.3009741, 629.4095226, 631.5156072, 633.619188, 635.7202249, 637.8186779, 639.914507, 642.0076724, 644.0981341, 646.1858524, 648.2707875, 650.3528998, 652.4321495, 654.5084972, 656.5819032, 658.6523282, 660.7197327, 662.7840772, 664.8453226, 666.9034296, 668.958359, 671.0100717, 673.0585285, 675.1036906, 677.145519, 679.1839748, 681.2190191, 683.2506134, 685.2787188, 687.3032967, 689.3243087, 691.3417162, 693.3554808, 695.3655642, 697.3719282, 699.3745345, 701.3733449, 703.3683215, 705.3594263, 707.3466213, 709.3298688, 711.3091309, 713.28437, 715.2555484, 717.2226287, 719.1855734, 721.1443451, 723.0989066, 725.0492205, 726.9952499, 728.9369576, 730.8743066, 732.8072602, 734.7357814, 736.6598336, 738.5793801, 740.4943845, 742.4048101, 744.3106207, 746.2117801, 748.1082518, 750, 751.8869885, 753.7691815, 755.646543, 757.5190375, 759.3866291, 761.2492824, 763.1069618, 764.9596321, 766.807258, 768.6498042, 770.4872357, 772.3195175, 774.1466148, 775.9684927, 777.7851165, 779.5964517, 781.4024638, 783.2031185, 784.9983813, 786.7882182, 788.572595, 790.3514779, 792.1248328, 793.8926261, 795.6548242, 797.4113934, 799.1623003, 800.9075116, 802.646994, 804.3807145, 806.10864, 807.8307377, 809.5469747, 811.2573183, 812.9617361, 814.6601955, 816.3526643, 818.0391101, 819.719501, 821.3938048, 823.0619898, 824.7240242, 826.3798762, 828.0295145, 829.6729076, 831.3100241, 832.940833, 834.5653032, 836.1834037, 837.7951038, 839.4003728, 840.99918, 842.5914952, 844.1772878, 845.7565279, 847.3291852, 848.8952299, 850.4546321, 852.0073622, 853.5533906, 855.0926878, 856.6252246, 858.1509717, 859.6699002, 861.181981, 862.6871855, 864.1854849, 865.6768508, 867.1612547, 868.6386684, 870.1090637, 871.5724127, 873.0286875, 874.4778604, 875.9199037, 877.3547901, 878.7824922, 880.2029828, 881.6162349, 883.0222216, 884.420916, 885.8122917, 887.196322, 888.5729807, 889.9422415, 891.3040784, 892.6584654, 894.0053768, 895.3447869, 896.6766701, 898.0010013, 899.317755, 900.6269063, 901.9284303, 903.2223021, 904.5084972, 905.786991, 907.0577592, 908.3207776, 909.5760221, 910.823469, 912.0630943, 913.2948746, 914.5187863, 915.7348062, 916.942911, 918.1430779, 919.335284, 920.5195065, 921.6957229, 922.8639109, 924.0240481, 925.1761125, 926.3200822, 927.4559353, 928.5836504, 929.7032058, 930.8145802, 931.9177526, 933.0127019, 934.0994072, 935.177848, 936.2480035, 937.3098536, 938.3633779, 939.4085563, 940.4453691, 941.4737964, 942.4938187, 943.5054166, 944.5085707, 945.5032621, 946.4894717, 947.4671808, 948.4363708, 949.3970231, 950.3491197, 951.2926422, 952.2275727, 953.1538935, 954.0715869, 954.9806354, 955.8810218, 956.7727288, 957.6557396, 958.5300372, 959.3956051, 960.2524267, 961.1004858, 961.9397663, 962.770252, 963.5919273, 964.4047764, 965.208784, 966.0039346, 966.7902132, 967.5676048, 968.3360946, 969.095668, 969.8463104, 970.5880076, 971.3207455, 972.0445102, 972.7592878, 973.4650647, 974.1618276, 974.8495631, 975.5282581, 976.1978998, 976.8584754, 977.5099722, 978.152378, 978.7856804, 979.4098674, 980.0249272, 980.630848, 981.2276182, 981.8152266, 982.3936619, 982.9629131, 983.5229695, 984.0738202, 984.6154549, 985.1478631, 985.6710349, 986.1849602, 986.6896292, 987.1850324, 987.6711603, 988.1480036, 988.6155532, 989.0738004, 989.5227362, 989.9623523, 990.3926402, 990.8135917, 991.2251989, 991.6274538, 992.0203488, 992.4038765, 992.7780295, 993.1428008, 993.4981833, 993.8441703, 994.1807552, 994.5079317, 994.8256934, 995.1340344, 995.4329487, 995.7224307, 996.0024748, 996.2730758, 996.5342285, 996.7859278, 997.0281691, 997.2609477, 997.4842591, 997.6980992, 997.9024638, 998.097349, 998.2827512, 998.4586669, 998.6250925, 998.7820251, 998.9294616, 999.0673992, 999.1958353, 999.3147674, 999.4241932, 999.5241108, 999.6145181, 999.6954135, 999.7667954, 999.8286625, 999.8810135, 999.9238476, 999.9571638, 999.9809615, 999.9952404, 1000, 999.9952404, 999.9809615, 999.9571638, 999.9238476, 999.8810135, 999.8286625, 999.7667954, 999.6954135, 999.6145181, 999.5241108, 999.4241932, 999.3147674, 999.1958353, 999.0673992, 998.9294616, 998.7820251, 998.6250925, 998.4586669, 998.2827512, 998.097349, 997.9024638, 997.6980992, 997.4842591, 997.2609477, 997.0281691, 996.7859278, 996.5342285, 996.2730758, 996.0024748, 995.7224307, 995.4329487, 995.1340344, 994.8256934, 994.5079317, 994.1807552, 993.8441703, 993.4981833, 993.1428008, 992.7780295, 992.4038765, 992.0203488, 991.6274538, 991.2251989, 990.8135917, 990.3926402, 989.9623523, 989.5227362, 989.0738004, 988.6155532, 988.1480036, 987.6711603, 987.1850324, 986.6896292, 986.1849602, 985.6710349, 985.1478631, 984.6154549, 984.0738202, 983.5229695, 982.9629131, 982.3936619, 981.8152266, 981.2276182, 980.630848, 980.0249272, 979.4098674, 978.7856804, 978.152378, 977.5099722, 976.8584754, 976.1978998, 975.5282581, 974.8495631, 974.1618276, 973.4650647, 972.7592878, 972.0445102, 971.3207455, 970.5880076, 969.8463104, 969.095668, 968.3360946, 967.5676048, 966.7902132, 966.0039346, 965.208784, 964.4047764, 963.5919273, 962.770252, 961.9397663, 961.1004858, 960.2524267, 959.3956051, 958.5300372, 957.6557396, 956.7727288, 955.8810218, 954.9806354, 954.0715869, 953.1538935, 952.2275727, 951.2926422, 950.3491197, 949.3970231, 948.4363708, 947.4671808, 946.4894717, 945.5032621, 944.5085707, 943.5054166, 942.4938187, 941.4737964, 940.4453691, 939.4085563, 938.3633779, 937.3098536, 936.2480035, 935.177848, 934.0994072, 933.0127019, 931.9177526, 930.8145802, 929.7032058, 928.5836504, 927.4559353, 926.3200822, 925.1761125, 924.0240481, 922.8639109, 921.6957229, 920.5195065, 919.335284, 918.1430779, 916.942911, 915.7348062, 914.5187863, 913.2948746, 912.0630943, 910.823469, 909.5760221, 908.3207776, 907.0577592, 905.786991, 904.5084972, 903.2223021, 901.9284303, 900.6269063, 899.317755, 898.0010013, 896.6766701, 895.3447869, 894.0053768, 892.6584654, 891.3040784, 889.9422415, 888.5729807, 887.196322, 885.8122917, 884.420916, 883.0222216, 881.6162349, 880.2029828, 878.7824922, 877.3547901, 875.9199037, 874.4778604, 873.0286875, 871.5724127, 870.1090637, 868.6386684, 867.1612547, 865.6768508, 864.1854849, 862.6871855, 861.181981, 859.6699002, 858.1509717, 856.6252246, 855.0926878, 853.5533906, 852.0073622, 850.4546321, 848.8952299, 847.3291852, 845.7565279, 844.1772878, 842.5914952, 840.99918, 839.4003728, 837.7951038, 836.1834037, 834.5653032, 832.940833, 831.3100241, 829.6729076, 828.0295145, 826.3798762, 824.7240242, 823.0619898, 821.3938048, 819.719501, 818.0391101, 816.3526643, 814.6601955, 812.9617361, 811.2573183, 809.5469747, 807.8307377, 806.10864, 804.3807145, 802.646994, 800.9075116, 799.1623003, 797.4113934, 795.6548242, 793.8926261, 792.1248328, 790.3514779, 788.572595, 786.7882182, 784.9983813, 783.2031185, 781.4024638, 779.5964517, 777.7851165, 775.9684927, 774.1466148, 772.3195175, 770.4872357, 768.6498042, 766.807258, 764.9596321, 763.1069618, 761.2492824, 759.3866291, 757.5190375, 755.646543, 753.7691815, 751.8869885, 750, 748.1082518, 746.2117801, 744.3106207, 742.4048101, 740.4943845, 738.5793801, 736.6598336, 734.7357814, 732.8072602, 730.8743066, 728.9369576, 726.9952499, 725.0492205, 723.0989066, 721.1443451, 719.1855734, 717.2226287, 715.2555484, 713.28437, 711.3091309, 709.3298688, 707.3466213, 705.3594263, 703.3683215, 701.3733449, 699.3745345, 697.3719282, 695.3655642, 693.3554808, 691.3417162, 689.3243087, 687.3032967, 685.2787188, 683.2506134, 681.2190191, 679.1839748, 677.145519, 675.1036906, 673.0585285, 671.0100717, 668.958359, 666.9034296, 664.8453226, 662.7840772, 660.7197327, 658.6523282, 656.5819032, 654.5084972, 652.4321495, 650.3528998, 648.2707875, 646.1858524, 644.0981341, 642.0076724, 639.914507, 637.8186779, 635.7202249, 633.619188, 631.5156072, 629.4095226, 627.3009741, 625.190002, 623.0766465, 620.9609478, 618.8429462, 616.7226819, 614.6001955, 612.4755272, 610.3487175, 608.219807, 606.0888361, 603.9558454, 601.8208756, 599.6839672, 597.545161, 595.4044977, 593.262018, 591.1177627, 588.9717727, 586.8240888, 584.6747519, 582.5238029, 580.3712828, 578.2172325, 576.0616931, 573.9047056, 571.746311, 569.5865505, 567.4254651, 565.2630961, 563.0994846, 560.9346717, 558.7686987, 556.6016069, 554.4334374, 552.2642316, 550.0940308, 547.9228763, 545.7508093, 543.5778714, 541.4041038, 539.2295479, 537.0542451, 534.8782369, 532.7015646, 530.5242698, 528.3463938, 526.1679781, 523.9890643, 521.8096937, 519.6299079, 517.4497484, 515.2692566, 513.0884742, 510.9074425, 508.7262032, 506.5447978, 504.3632677, 502.1816546, 500, 497.8183454, 495.6367323, 493.4552022, 491.2737968, 489.0925575, 486.9115258, 484.7307434, 482.5502516, 480.3700921, 478.1903063, 476.0109357, 473.8320219, 471.6536062, 469.4757302, 467.2984354, 465.1217631, 462.9457549, 460.7704521, 458.5958962, 456.4221286, 454.2491907, 452.0771237, 449.9059692, 447.7357684, 445.5665626, 443.3983931, 441.2313013, 439.0653283, 436.9005154, 434.7369039, 432.5745349, 430.4134495, 428.253689, 426.0952944, 423.9383069, 421.7827675, 419.6287172, 417.4761971, 415.3252481, 413.1759112, 411.0282273, 408.8822373, 406.737982, 404.5955023, 402.454839, 400.3160328, 398.1791244, 396.0441546, 393.9111639, 391.780193, 389.6512825, 387.5244728, 385.3998045, 383.2773181, 381.1570538, 379.0390522, 376.9233535, 374.809998, 372.6990259, 370.5904774, 368.4843928, 366.380812, 364.2797751, 362.1813221, 360.085493, 357.9923276, 355.9018659, 353.8141476, 351.7292125, 349.6471002, 347.5678505, 345.4915028, 343.4180968, 341.3476718, 339.2802673, 337.2159228, 335.1546774, 333.0965704, 331.041641, 328.9899283, 326.9414715, 324.8963094, 322.854481, 320.8160252, 318.7809809, 316.7493866, 314.7212812, 312.6967033, 310.6756913, 308.6582838, 306.6445192, 304.6344358, 302.6280718, 300.6254655, 298.6266551, 296.6316785, 294.6405737, 292.6533787, 290.6701312, 288.6908691, 286.71563, 284.7444516, 282.7773713, 280.8144266, 278.8556549, 276.9010934, 274.9507795, 273.0047501, 271.0630424, 269.1256934, 267.1927398, 265.2642186, 263.3401664, 261.4206199, 259.5056155, 257.5951899, 255.6893793, 253.7882199, 251.8917482, 250, 248.1130115, 246.2308185, 244.353457, 242.4809625, 240.6133709, 238.7507176, 236.8930382, 235.0403679, 233.192742, 231.3501958, 229.5127643, 227.6804825, 225.8533852, 224.0315073, 222.2148835, 220.4035483, 218.5975362, 216.7968815, 215.0016187, 213.2117818, 211.427405, 209.6485221, 207.8751672, 206.1073739, 204.3451758, 202.5886066, 200.8376997, 199.0924884, 197.353006, 195.6192855, 193.89136, 192.1692623, 190.4530253, 188.7426817, 187.0382639, 185.3398045, 183.6473357, 181.9608899, 180.280499, 178.6061952, 176.9380102, 175.2759758, 173.6201238, 171.9704855, 170.3270924, 168.6899759, 167.059167, 165.4346968, 163.8165963, 162.2048962, 160.5996272, 159.00082, 157.4085048, 155.8227122, 154.2434721, 152.6708148, 151.1047701, 149.5453679, 147.9926378, 146.4466094, 144.9073122, 143.3747754, 141.8490283, 140.3300998, 138.818019, 137.3128145, 135.8145151, 134.3231492, 132.8387453, 131.3613316, 129.8909363, 128.4275873, 126.9713125, 125.5221396, 124.0800963, 122.6452099, 121.2175078, 119.7970172, 118.3837651, 116.9777784, 115.579084, 114.1877083, 112.803678, 111.4270193, 110.0577585, 108.6959216, 107.3415346, 105.9946232, 104.6552131, 103.3233299, 101.9989987, 100.682245, 99.37309365, 98.07156969, 96.77769787, 95.49150281, 94.21300902, 92.94224082, 91.67922242, 90.42397786, 89.17653103, 87.93690569, 86.70512544, 85.48121372, 84.26519385, 83.05708897, 81.85692208, 80.66471603, 79.48049352, 78.30427709, 77.13608915, 75.97595192, 74.8238875, 73.67991782, 72.54406466, 71.41634965, 70.29679425, 69.18541978, 68.0822474, 66.98729811, 65.90059276, 64.82215203, 63.75199646, 62.69014643, 61.63662215, 60.59144367, 59.5546309, 58.52620357, 57.50618127, 56.49458341, 55.49142926, 54.49673791, 53.51052829, 52.5328192, 51.56362923, 50.60297685, 49.65088034, 48.70735783, 47.77242727, 46.84610648, 45.92841309, 45.01936456, 44.11897821, 43.22727118, 42.34426044, 41.46996281, 40.60439493, 39.74757327, 38.89951416, 38.06023374, 37.22974799, 36.40807272, 35.59522356, 34.79121601, 33.99606536, 33.20978675, 32.43239516, 31.66390538, 30.90433204, 30.15368961, 29.41199237, 28.67925445, 27.9554898, 27.2407122, 26.53493525, 25.8381724, 25.1504369, 24.47174185, 23.80210018, 23.14152463, 22.49002777, 21.84762202, 21.2143196, 20.59013257, 19.97507281, 19.36915203, 18.77238177, 18.1847734, 17.60633809, 17.03708686, 16.47703054, 15.92617981, 15.38454515, 14.85213686, 14.32896509, 13.8150398, 13.31037077, 12.81496761, 12.32883975, 11.85199644, 11.38444677, 10.92619963, 10.47726376, 10.03764769, 9.607359798, 9.186408276, 8.774801137, 8.372546218, 7.979651177, 7.596123494, 7.221970471, 6.857199231, 6.50181672, 6.155829702, 5.819244766, 5.492068319, 5.17430659, 4.865965629, 4.567051307, 4.277569313, 3.99752516, 3.726924179, 3.465771523, 3.214072162, 2.971830889, 2.739052316, 2.515740875, 2.301900816, 2.097536213, 1.902650954, 1.717248751, 1.541333133, 1.37490745, 1.21797487, 1.070538381, 0.932600789, 0.804164721, 0.685232623, 0.575806758, 0.475889209, 0.38548188, 0.30458649, 0.233204582, 0.171337512, 0.11898646, 0.076152422, 0.042836213, 0.019038468, 0.00475964, 0, 0.00475964, 0.019038468, 0.042836213, 0.076152422, 0.11898646, 0.171337512, 0.233204582, 0.30458649, 0.38548188, 0.475889209, 0.575806758, 0.685232623, 0.804164721, 0.932600789, 1.070538381, 1.21797487, 1.37490745, 1.541333133, 1.717248751, 1.902650954, 2.097536213, 2.301900816, 2.515740875, 2.739052316, 2.971830889, 3.214072162, 3.465771523, 3.726924179, 3.99752516, 4.277569313, 4.567051307, 4.865965629, 5.17430659, 5.492068319, 5.819244766, 6.155829702, 6.50181672, 6.857199231, 7.221970471, 7.596123494, 7.979651177, 8.372546218, 8.774801137, 9.186408276, 9.607359798, 10.03764769, 10.47726376, 10.92619963, 11.38444677, 11.85199644, 12.32883975, 12.81496761, 13.31037077, 13.8150398, 14.32896509, 14.85213686, 15.38454515, 15.92617981, 16.47703054, 17.03708686, 17.60633809, 18.1847734, 18.77238177, 19.36915203, 19.97507281, 20.59013257, 21.2143196, 21.84762202, 22.49002777, 23.14152463, 23.80210018, 24.47174185, 25.1504369, 25.8381724, 26.53493525, 27.2407122, 27.9554898, 28.67925445, 29.41199237, 30.15368961, 30.90433204, 31.66390538, 32.43239516, 33.20978675, 33.99606536, 34.79121601, 35.59522356, 36.40807272, 37.22974799, 38.06023374, 38.89951416, 39.74757327, 40.60439493, 41.46996281, 42.34426044, 43.22727118, 44.11897821, 45.01936456, 45.92841309, 46.84610648, 47.77242727, 48.70735783, 49.65088034, 50.60297685, 51.56362923, 52.5328192, 53.51052829, 54.49673791, 55.49142926, 56.49458341, 57.50618127, 58.52620357, 59.5546309, 60.59144367, 61.63662215, 62.69014643, 63.75199646, 64.82215203, 65.90059276, 66.98729811, 68.0822474, 69.18541978, 70.29679425, 71.41634965, 72.54406466, 73.67991782, 74.8238875, 75.97595192, 77.13608915, 78.30427709, 79.48049352, 80.66471603, 81.85692208, 83.05708897, 84.26519385, 85.48121372, 86.70512544, 87.93690569, 89.17653103, 90.42397786, 91.67922242, 92.94224082, 94.21300902, 95.49150281, 96.77769787, 98.07156969, 99.37309365, 100.682245, 101.9989987, 103.3233299, 104.6552131, 105.9946232, 107.3415346, 108.6959216, 110.0577585, 111.4270193, 112.803678, 114.1877083, 115.579084, 116.9777784, 118.3837651, 119.7970172, 121.2175078, 122.6452099, 124.0800963, 125.5221396, 126.9713125, 128.4275873, 129.8909363, 131.3613316, 132.8387453, 134.3231492, 135.8145151, 137.3128145, 138.818019, 140.3300998, 141.8490283, 143.3747754, 144.9073122, 146.4466094, 147.9926378, 149.5453679, 151.1047701, 152.6708148, 154.2434721, 155.8227122, 157.4085048, 159.00082, 160.5996272, 162.2048962, 163.8165963, 165.4346968, 167.059167, 168.6899759, 170.3270924, 171.9704855, 173.6201238, 175.2759758, 176.9380102, 178.6061952, 180.280499, 181.9608899, 183.6473357, 185.3398045, 187.0382639, 188.7426817, 190.4530253, 192.1692623, 193.89136, 195.6192855, 197.353006, 199.0924884, 200.8376997, 202.5886066, 204.3451758, 206.1073739, 207.8751672, 209.6485221, 211.427405, 213.2117818, 215.0016187, 216.7968815, 218.5975362, 220.4035483, 222.2148835, 224.0315073, 225.8533852, 227.6804825, 229.5127643, 231.3501958, 233.192742, 235.0403679, 236.8930382, 238.7507176, 240.6133709, 242.4809625, 244.353457, 246.2308185, 248.1130115, 250, 251.8917482, 253.7882199, 255.6893793, 257.5951899, 259.5056155, 261.4206199, 263.3401664, 265.2642186, 267.1927398, 269.1256934, 271.0630424, 273.0047501, 274.9507795, 276.9010934, 278.8556549, 280.8144266, 282.7773713, 284.7444516, 286.71563, 288.6908691, 290.6701312, 292.6533787, 294.6405737, 296.6316785, 298.6266551, 300.6254655, 302.6280718, 304.6344358, 306.6445192, 308.6582838, 310.6756913, 312.6967033, 314.7212812, 316.7493866, 318.7809809, 320.8160252, 322.854481, 324.8963094, 326.9414715, 328.9899283, 331.041641, 333.0965704, 335.1546774, 337.2159228, 339.2802673, 341.3476718, 343.4180968, 345.4915028, 347.5678505, 349.6471002, 351.7292125, 353.8141476, 355.9018659, 357.9923276, 360.085493, 362.1813221, 364.2797751, 366.380812, 368.4843928, 370.5904774, 372.6990259, 374.809998, 376.9233535, 379.0390522, 381.1570538, 383.2773181, 385.3998045, 387.5244728, 389.6512825, 391.780193, 393.9111639, 396.0441546, 398.1791244, 400.3160328, 402.454839, 404.5955023, 406.737982, 408.8822373, 411.0282273, 413.1759112, 415.3252481, 417.4761971, 419.6287172, 421.7827675, 423.9383069, 426.0952944, 428.253689, 430.4134495, 432.5745349, 434.7369039, 436.9005154, 439.0653283, 441.2313013, 443.3983931, 445.5665626, 447.7357684, 449.9059692, 452.0771237, 454.2491907, 456.4221286, 458.5958962, 460.7704521, 462.9457549, 465.1217631, 467.2984354, 469.4757302, 471.6536062, 473.8320219, 476.0109357, 478.1903063, 480.3700921, 482.5502516, 484.7307434, 486.9115258, 489.0925575, 491.2737968, 493.4552022, 495.6367323, 497.8183454};
float sin_lut[SVPWM_SIZE] = {128, 128, 129, 129, 130, 130, 131, 131, 132, 133, 133, 134, 134, 135, 135, 136, 136, 137, 138, 138, 139, 139, 140, 140, 141, 141, 142, 142, 143, 144, 144, 145, 145, 146, 146, 147, 147, 148, 149, 149, 150, 150, 151, 151, 152, 152, 153, 153, 154, 155, 155, 156, 156, 157, 157, 158, 158, 159, 159, 160, 160, 161, 162, 162, 163, 163, 164, 164, 165, 165, 166, 166, 167, 167, 168, 168, 169, 170, 170, 171, 171, 172, 172, 173, 173, 174, 174, 175, 175, 176, 176, 177, 177, 178, 178, 179, 179, 180, 180, 181, 181, 182, 182, 183, 183, 184, 184, 185, 185, 186, 186, 187, 187, 188, 188, 189, 189, 190, 190, 191, 191, 192, 192, 193, 193, 194, 194, 195, 195, 196, 196, 196, 197, 197, 198, 198, 199, 199, 200, 200, 201, 201, 202, 202, 202, 203, 203, 204, 204, 205, 205, 206, 206, 206, 207, 207, 208, 208, 209, 209, 209, 210, 210, 211, 211, 212, 212, 212, 213, 213, 214, 214, 214, 215, 215, 216, 216, 216, 217, 217, 218, 218, 218, 219, 219, 220, 220, 220, 221, 221, 222, 222, 222, 223, 223, 223, 224, 224, 224, 225, 225, 226, 226, 226, 227, 227, 227, 228, 228, 228, 229, 229, 229, 230, 230, 230, 231, 231, 231, 232, 232, 232, 233, 233, 233, 234, 234, 234, 234, 235, 235, 235, 236, 236, 236, 237, 237, 237, 237, 238, 238, 238, 238, 239, 239, 239, 240, 240, 240, 240, 241, 241, 241, 241, 242, 242, 242, 242, 243, 243, 243, 243, 244, 244, 244, 244, 244, 245, 245, 245, 245, 246, 246, 246, 246, 246, 247, 247, 247, 247, 247, 247, 248, 248, 248, 248, 248, 249, 249, 249, 249, 249, 249, 250, 250, 250, 250, 250, 250, 251, 251, 251, 251, 251, 251, 251, 251, 252, 252, 252, 252, 252, 252, 252, 252, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 252, 252, 252, 252, 252, 252, 252, 252, 251, 251, 251, 251, 251, 251, 251, 251, 250, 250, 250, 250, 250, 250, 249, 249, 249, 249, 249, 249, 248, 248, 248, 248, 248, 247, 247, 247, 247, 247, 247, 246, 246, 246, 246, 246, 245, 245, 245, 245, 244, 244, 244, 244, 244, 243, 243, 243, 243, 242, 242, 242, 242, 241, 241, 241, 241, 240, 240, 240, 240, 239, 239, 239, 238, 238, 238, 238, 237, 237, 237, 237, 236, 236, 236, 235, 235, 235, 234, 234, 234, 234, 233, 233, 233, 232, 232, 232, 231, 231, 231, 230, 230, 230, 229, 229, 229, 228, 228, 228, 227, 227, 227, 226, 226, 226, 225, 225, 224, 224, 224, 223, 223, 223, 222, 222, 222, 221, 221, 220, 220, 220, 219, 219, 218, 218, 218, 217, 217, 216, 216, 216, 215, 215, 214, 214, 214, 213, 213, 212, 212, 212, 211, 211, 210, 210, 209, 209, 209, 208, 208, 207, 207, 206, 206, 206, 205, 205, 204, 204, 203, 203, 202, 202, 202, 201, 201, 200, 200, 199, 199, 198, 198, 197, 197, 196, 196, 196, 195, 195, 194, 194, 193, 193, 192, 192, 191, 191, 190, 190, 189, 189, 188, 188, 187, 187, 186, 186, 185, 185, 184, 184, 183, 183, 182, 182, 181, 181, 180, 180, 179, 179, 178, 178, 177, 177, 176, 176, 175, 175, 174, 174, 173, 173, 172, 172, 171, 171, 170, 170, 169, 168, 168, 167, 167, 166, 166, 165, 165, 164, 164, 163, 163, 162, 162, 161, 160, 160, 159, 159, 158, 158, 157, 157, 156, 156, 155, 155, 154, 153, 153, 152, 152, 151, 151, 150, 150, 149, 149, 148, 147, 147, 146, 146, 145, 145, 144, 144, 143, 142, 142, 141, 141, 140, 140, 139, 139, 138, 138, 137, 136, 136, 135, 135, 134, 134, 133, 133, 132, 131, 131, 130, 130, 129, 129, 128, 128, 127, 126, 126, 125, 125, 124, 124, 123, 122, 122, 121, 121, 120, 120, 119, 119, 118, 117, 117, 116, 116, 115, 115, 114, 114, 113, 113, 112, 111, 111, 110, 110, 109, 109, 108, 108, 107, 106, 106, 105, 105, 104, 104, 103, 103, 102, 102, 101, 100, 100, 99, 99, 98, 98, 97, 97, 96, 96, 95, 95, 94, 93, 93, 92, 92, 91, 91, 90, 90, 89, 89, 88, 88, 87, 87, 86, 85, 85, 84, 84, 83, 83, 82, 82, 81, 81, 80, 80, 79, 79, 78, 78, 77, 77, 76, 76, 75, 75, 74, 74, 73, 73, 72, 72, 71, 71, 70, 70, 69, 69, 68, 68, 67, 67, 66, 66, 65, 65, 64, 64, 63, 63, 62, 62, 61, 61, 60, 60, 59, 59, 59, 58, 58, 57, 57, 56, 56, 55, 55, 54, 54, 53, 53, 53, 52, 52, 51, 51, 50, 50, 49, 49, 49, 48, 48, 47, 47, 46, 46, 46, 45, 45, 44, 44, 43, 43, 43, 42, 42, 41, 41, 41, 40, 40, 39, 39, 39, 38, 38, 37, 37, 37, 36, 36, 35, 35, 35, 34, 34, 33, 33, 33, 32, 32, 32, 31, 31, 31, 30, 30, 29, 29, 29, 28, 28, 28, 27, 27, 27, 26, 26, 26, 25, 25, 25, 24, 24, 24, 23, 23, 23, 22, 22, 22, 21, 21, 21, 21, 20, 20, 20, 19, 19, 19, 18, 18, 18, 18, 17, 17, 17, 17, 16, 16, 16, 15, 15, 15, 15, 14, 14, 14, 14, 13, 13, 13, 13, 12, 12, 12, 12, 11, 11, 11, 11, 11, 10, 10, 10, 10, 9, 9, 9, 9, 9, 8, 8, 8, 8, 8, 8, 7, 7, 7, 7, 7, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11, 11, 11, 11, 12, 12, 12, 12, 13, 13, 13, 13, 14, 14, 14, 14, 15, 15, 15, 15, 16, 16, 16, 17, 17, 17, 17, 18, 18, 18, 18, 19, 19, 19, 20, 20, 20, 21, 21, 21, 21, 22, 22, 22, 23, 23, 23, 24, 24, 24, 25, 25, 25, 26, 26, 26, 27, 27, 27, 28, 28, 28, 29, 29, 29, 30, 30, 31, 31, 31, 32, 32, 32, 33, 33, 33, 34, 34, 35, 35, 35, 36, 36, 37, 37, 37, 38, 38, 39, 39, 39, 40, 40, 41, 41, 41, 42, 42, 43, 43, 43, 44, 44, 45, 45, 46, 46, 46, 47, 47, 48, 48, 49, 49, 49, 50, 50, 51, 51, 52, 52, 53, 53, 53, 54, 54, 55, 55, 56, 56, 57, 57, 58, 58, 59, 59, 59, 60, 60, 61, 61, 62, 62, 63, 63, 64, 64, 65, 65, 66, 66, 67, 67, 68, 68, 69, 69, 70, 70, 71, 71, 72, 72, 73, 73, 74, 74, 75, 75, 76, 76, 77, 77, 78, 78, 79, 79, 80, 80, 81, 81, 82, 82, 83, 83, 84, 84, 85, 85, 86, 87, 87, 88, 88, 89, 89, 90, 90, 91, 91, 92, 92, 93, 93, 94, 95, 95, 96, 96, 97, 97, 98, 98, 99, 99, 100, 100, 101, 102, 102, 103, 103, 104, 104, 105, 105, 106, 106, 107, 108, 108, 109, 109, 110, 110, 111, 111, 112, 113, 113, 114, 114, 115, 115, 116, 116, 117, 117, 118, 119, 119, 120, 120, 121, 121, 122, 122, 123, 124, 124, 125, 125, 126, 126, 127};

// PID control modes
PID pid_angle, pid_rpm, pid_focIq, pid_focId;

// Encoder calibration
double encoder_calib_data[] = {7.91, 37.08, 66.35, 95.71, 126.4, 157.23, 187.73, 217.17, 246.35, 275.8, 306.47, 337.23};
double encoder_LUT[(int)ENCODER_RES];

// FOC
volatile float foc_id = 0, foc_iq = 0;

// Sensorless
volatile float phase_delay = 0;
volatile uint8_t current_phase = 0;
volatile bool sensorless_flag = false;
volatile uint8_t comp_rshift, bemf_dir;
volatile unsigned char comp_u, comp_v, comp_w, comparator = 0;

// Motor modes
volatile motor_mode mode = MODE_POWER;
volatile motor_waveform_type waveform_mode = MOTOR_SVPWM;

volatile float position = 0.0, rpm = 0.0, rpm_der = 0.0, power = 0.0;

float motor_zero_angle = 0.0;

void __ISR_AT_VECTOR(_TIMER_4_VECTOR, IPL6AUTO) FOC_loop(void){
	IFS0bits.T4IF = 0;
	
	LED0 = 1;
	
	static long int pos_cnt;
	pos_cnt = POS1CNT;
	
	if(pos_cnt < 0) {
		pos_cnt += ENCODER_RES;
	}
	pos_cnt &= ENCODER_RES_MASK;
	
	position = encoder_LUT[pos_cnt] - motor_zero_angle + rpm * RPM_ADVANCE_FACTOR;
//	position = ((float)pos_cnt * 360.0 / ENCODER_RES) - motor_zero_angle + rpm * RPM_ADVANCE_FACTOR;
//	position = ((float)(4095 - spi_angle) * 360.0 / 4095.0) - motor_zero_angle;
	
	if(position < 0.0) {
		position += 360.0;
	}else if(position > 360.0) {
		position -= 360.0;
	}

	foc_current_calc(position*pole_pairs);

	if(mode != MODE_OFF) {
		if(power) {
			PID_compute(&pid_focIq, foc_iq, 0.00004);
			PID_compute(&pid_focId, foc_id, 0.00004);
		} else {
			PID_reset(&pid_focIq);
			PID_reset(&pid_focId);
		}
//		setPhaseVoltage(power, 0, position*pole_pairs + power/fabs(power)*foc_degree_advance);
		setPhaseVoltage(power, 0, position*pole_pairs);
	}
	LED0 = 0;
}

#define RPM_LPF 0.95
#define RPM_DER_LPF 0.9

void __ISR_AT_VECTOR(_TIMER_6_VECTOR, IPL4AUTO) RPM(void){
	IFS2bits.T6IF = 0;
	static volatile long int temp = 0, p_temp;
	static volatile float p_rpm = 0.0;

	static long int ind_cnt;
	static float net_position;
	
	p_temp = temp;
	temp = VEL1CNT;
	
	p_rpm = rpm;
	rpm = (1.0-RPM_LPF) * ((float)temp / ENCODER_RES * 30000.0) + RPM_LPF*rpm;
	
	//rpm_der = (1.0-RPM_LPF) * ((float)(temp-p_temp) / ENCODER_RES * 60000.0) + RPM_LPF*rpm_der;    
	rpm_der = (1.0-RPM_DER_LPF)*(rpm-p_rpm) + RPM_DER_LPF*rpm_der;
	
	// RPM PID control
	if(mode == MODE_RPM) {        
		PID_compute(&pid_angle, net_position, 0.002);

		if(pid_rpm.setpoint == 0 && fabs(rpm) < 25) {
			power = 0;
		} else {
			power = pid_rpm.output;
		}
		
	// Angle PID control
	} else if (mode == MODE_POS) {
		ind_cnt = INDX1CNT;
		net_position = position + ind_cnt * 360.0;

		power = PID_compute(&pid_angle, net_position, 0.002) / 2000.0;
	}
}

void setPhaseVoltage(float p, float p_d, float angle_el) {
	float pwm_u, pwm_v, pwm_w;
	float s, c;

	float center;
	float Ud, Uq;
	float Ualpha, Ubeta;
	float Umin, Umax;

	static float *PWM_table;
	int index;

	p = p < -1.0 ? -1.0 : p > 1.0 ? 1.0 : p;
	
	if(waveform_mode == MOTOR_FOC) {
//		p = fabs(p);
		p *= (float)PWM_MAX/2 ;
		angle_el = normalizeAngle(angle_el);
		
		index = angle_el * 4;
		index = index < 0.0 | index >= SVPWM_SIZE ? 0 : index;
		s = (sin_lut[index] - 128.0) / 128.0;
		index = (index + SVPWM_SIZE/4) % SVPWM_SIZE;
		c = (sin_lut[index] - 128.0) / 128.0;

		Uq = p;//-pid_focIq.output;
		Ud = 0;//pid_focId.output;

		// Inverse Park Transform
		Ualpha = c * Ud - s * Uq;
		Ubeta = s * Ud + c * Uq;

		// Inverse Clarke Transform
		pwm_u = Ualpha;
		pwm_v = -0.5f * Ualpha - _SQRT3_2 * Ubeta;
		pwm_w = -0.5f * Ualpha + _SQRT3_2 * Ubeta;

		center = PWM_MAX/2;
		
		// SVPWM
		Umin = fmin(pwm_u, fmin(pwm_v, pwm_w));
		Umax = fmax(pwm_u, fmax(pwm_v, pwm_w));
		center -= (Umax+Umin) / 2;

		pwm_u += center;
		pwm_v += center;
		pwm_w += center;

//		pwm_u -= Umin;
//		pwm_v -= Umin;
//		pwm_w -= Umin;
		
	} else if(waveform_mode == MOTOR_SIN || waveform_mode == MOTOR_SVPWM) {

		// if(p < 0) angle_el += 180;
		p = fabs(p);
		p *= (float)PWM_MAX;
		angle_el = normalizeAngle(angle_el);
		
		if(waveform_mode == MOTOR_SIN) {
			PWM_table = SIN_table;
		} else if(waveform_mode == MOTOR_SVPWM){
			PWM_table = SVPWM_table;
		}
		
		index = angle_el * 4;
		index = index < 0.0 | index >= SVPWM_SIZE ? 0 : index;
		
		pwm_u = (float)PWM_table[index]/svpwm_max * p;
		
		index = (index + SVPWM_INCREMENT) % SVPWM_SIZE;
		pwm_v = (float)PWM_table[index]/svpwm_max * p;
		
		index = (index + SVPWM_INCREMENT) % SVPWM_SIZE;
		pwm_w = (float)PWM_table[index]/svpwm_max * p;
		
	} else if(waveform_mode == MOTOR_TRAPEZOID) {
		p = fabs(p);
		angle_el = normalizeAngle(angle_el);
		angle_el = round(angle_el / 60);
		MotorPhase((signed char)angle_el, p);
	}

	if(waveform_mode != MOTOR_TRAPEZOID) {
		// Clamp PWM to [0, PWM_MAX - DEAD_TIME]
		pwm_u = pwm_u > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_u < 0 ? 0: pwm_u;
		pwm_v = pwm_v > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_v < 0 ? 0: pwm_v;
		pwm_w = pwm_w > (PWM_MAX - DEAD_TIME) ? (PWM_MAX - DEAD_TIME): pwm_w < 0 ? 0: pwm_w;
		
		if(pwm_u) {
			PDC1 = pwm_u;
			PDC7 = pwm_u + DEAD_TIME;
		} else {
			PDC1 = pwm_u;
			PDC7 = pwm_u;
		}
		
		if(pwm_v) {
			PDC2 = pwm_v;
			PDC8 = pwm_v + DEAD_TIME;
		} else {
			PDC2 = pwm_v;
			PDC8 = pwm_v ;
		}

		if(pwm_w) {
			PDC3 = pwm_w;
			PDC9 = pwm_w + DEAD_TIME;
		} else {
			PDC3 = pwm_w;
			PDC9 = pwm_w;
		}
	}
}

#define FOC_IQ_LPF 0.999f
void foc_current_calc(float angle_el) {
	float s, c;
	uint16_t angle_index;
	float i_alpha, i_beta;
	float isns_u, isns_v, isns_w;

	angle_index = (int)(normalizeAngle(angle_el) * 4) % SVPWM_SIZE;
	s = (sin_lut[angle_index] - 128.0) / 128.0;
	angle_index = (angle_index + SVPWM_SIZE/4) % SVPWM_SIZE;
	c = (sin_lut[angle_index] - 128.0) / 128.0;

	// Get phase current readings from ADC
	isns_u = ((float)adc_buffer[1][0][0] * ADC_CONV_FACTOR - isns_u_offset) / 20.0f / ISNS_UVW_R;
	isns_v = ((float)adc_buffer[4][0][0] * ADC_CONV_FACTOR - isns_v_offset) / 20.0f / ISNS_UVW_R;
	isns_w = -(isns_u + isns_v);

	// Clarke Transform
	i_alpha = isns_u;
	i_beta = _1_SQRT3 * isns_u + _2_SQRT3 * isns_w;

	// Park Transform
	foc_iq = FOC_IQ_LPF*foc_iq + (1.0-FOC_IQ_LPF) * (-i_alpha* s + i_beta* c);
	foc_id = FOC_IQ_LPF*foc_id + (1.0-FOC_IQ_LPF) * (i_alpha* c + i_beta* s);
}


/*---------------------------------------------------------------------
 |                            Sensorless                              |
 ----------------------------------------------------------------------*/

void SensorlessStart(float p) {
	sensorless_flag = false;
	power = p;
	current_phase = 0;
	waveform_mode = MODE_SENSORLESS;
	
	comp_rshift = 0;
	bemf_dir = 1;
	
	IEC5bits.PWM4IE = 0;
	
	TMR8 = 0;
	PR8 = 3600;
	T8CONbits.ON = 1;
}

void __ISR(_TIMER_8_VECTOR, IPL7SOFT) Sensorless_timer(void) {
	IFS2bits.T8IF = 0;
	
	LATDINV |= 1 << 6;
	PR8 = 0xFFFFFFFF;
	T8CONbits.ON = 0;
	
//	if(sensorless_flag) {
//		sensorless_flag = false;
//		current_phase = (current_phase + 1) % 6;
//		MotorPhase(current_phase, power);
//		TMR8 = 0;
//		PR8 = 3600;
//	
//	} else {
//		IEC5bits.PWM4IE = 1;
//		PR8 = 0xFFFFFFFF;
//		TMR8 = 3600;
//	}
}

volatile bool bemf_flag;
volatile uint8_t pwm_odd = 0;
void __ISR(_PWM4_VECTOR, IPL7AUTO) PWM_sync_timer(void) {
//    PWMCON4bits.TRGIF = 0;
	PWMCON4bits.PWMHIF = 0;
	IFS5bits.PWM4IF = 0;
	
	if(pwm_odd == 1) {
		comparator = (PORTG >> 6) & 0b111;
		comp_u = (comparator >> 2) & 1;
		comp_v = (comparator >> 1) & 1;
		comp_w = comparator & 1;

//		LATDINV |= 1 << 6;
	
//		TMR8 = 0;
//		PR8 = 10;
//		T8CONbits.ON = 1;
	
//		if(waveform_mode == MODE_SENSORLESS) {
//			if(current_phase == 0) {
//				if(comparator & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 1) {
//				if(!((comparator >> 1) & 1)) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 2) {
//				if((comparator >> 2) & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 3) {
//				if(!(comparator & 1)) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 4) {
//				if((comparator >> 1) & 1) {
//					bemf_flag = true;
//				}
//			} else if(current_phase == 5) {
//				if(!((comparator >> 2) & 1)) {
//					bemf_flag = true;
//				}
//			}
//			if(bemf_flag) {
//				IEC5bits.PWM4IE = 0;
//				sensorless_flag = true;
//				phase_delay = (1.0f-LPF_PHASE)*phase_delay + LPF_PHASE*(float)TMR8;
//				TMR8 = 0;
//				PR8 = phase_delay;
//			}
//		}
	}
	
	pwm_odd = (pwm_odd + 1) % 2;
}

void MotorPhase(signed char num, float val) {
	val = val * (float)PWM_MAX;
	num = num % 6;
	if(num < 0) {
		num += 6;
	}
	switch(num) {
		case 0:
			// W - NC
			PDC1 = 0;
			PDC7 = PWM_MAX;
			// V - V+
			PDC2 = val;
			PDC8 = val;
			// U - GND
			PDC3 = 0;
			PDC9 = 0;
			break;
		case 1:
			// W - V+
			PDC1 = val;
			PDC7 = val;
			// V - NC
			PDC2 = 0;
			PDC8 = PWM_MAX;
			// U - GND
			PDC3 = 0;
			PDC9 = 0;
			break;
		case 2:
			// W - V+
			PDC1 = val;
			PDC7 = val;
			// V - GND
			PDC2 = 0;
			PDC8 = 0;
			// U - NC
			PDC3 = 0;
			PDC9 = PWM_MAX;
			break;
		case 3:
			// W - NC
			PDC1 = 0;
			PDC7 = PWM_MAX;
			// V - GND
			PDC2 = 0;
			PDC8 = 0;
			// U - V+
			PDC3 = val;
			PDC9 = val;
			break;
		case 4:
			// W - GND
			PDC1 = 0;
			PDC7 = 0;
			// V - NC
			PDC2 = 0;
			PDC8 = PWM_MAX;
			// U - V+
			PDC3 = val;
			PDC9 = val;
			break;
		case 5:
			// W - GND
			PDC1 = 0;
			PDC7 = 0;
			// V - V+
			PDC2 = val;
			PDC8 = val;
			// U - NC
			PDC3 = 0;
			PDC9 = PWM_MAX;
			break;       
	}
}

bool bemf_phase(unsigned char phase) {
	phase = phase % 6;
	if(phase == 0) {
		return comp_w;
	} else if(phase == 1) {
		return !comp_v;
	} else if(phase == 2) {
		return comp_u;
	} else if(phase == 3) {
		return !comp_w;
	} else if(phase == 4) {
		return comp_v;
	} else if(phase == 5) {
		return !comp_u;
	}
	return false;
}

/*---------------------------------------------------------------------
 |                                PID                                 |
 ----------------------------------------------------------------------*/

void MotorPIDInit() {
	PID_init(&pid_angle);
	PID_init(&pid_rpm);
	PID_init(&pid_focIq);
	PID_init(&pid_focId);

	PID_setGain(&pid_angle,	8,		1.25,	6		);
	PID_setGain(&pid_rpm,	0.0002,	0.005,	0.008	);
	PID_setGain(&pid_focIq,	100,	100,	0		);
	PID_setGain(&pid_focId,	20,		20,		0		);

	PID_setLPF(&pid_angle,	0.8);
	PID_setLPF(&pid_rpm,	0.8);

	PID_enableIntegralConstrain(&pid_angle);
	PID_setOutputLimits(&pid_angle,	-250,	250);

	PID_enableErrorConstrain(&pid_rpm);
	PID_setErrorLimits(&pid_rpm,	-500,	500);

	PID_enableErrorConstrain(&pid_focIq);
	PID_setErrorLimits(&pid_focIq, -1, 1);
	PID_enableOutputConstrain(&pid_focIq);
	PID_setOutputLimits(&pid_focIq, -1000, 1000);
	
	PID_enableErrorConstrain(&pid_focId);
	PID_setErrorLimits(&pid_focId, -1, 1);
	PID_enableIntegralConstrain(&pid_focId);
	PID_setOutputLimits(&pid_focId, -1000, 1000);
}

void ResetMotorPID() {
	PID_reset(&pid_angle);
	PID_reset(&pid_rpm);
}

void SetPower(float p) {
	power = p;
}

void SetRPM(float rpm) {
	pid_rpm.setpoint = rpm;
}

void SetPosition(float pos) {
	pid_angle.setpoint = pos;
}

float GetPosition() {
	return position;
}

float GetPower() {
	return power;
}

void ResetPosition() {
	unsigned long int t = VEL1CNT;
	INDX1CNT = 0;
	position = 0.0;
}

float GetRPM() {
	return rpm;
}

float GetRPM_der() {
	return rpm_der;
}

float normalizeAngle(float angle) {
	float a = fmod(angle, 360.0f);
	return a >= 0 ? a : (a + 360.0f);
}

void MotorOff() {
	power = 0;
	// A - NC
	PDC1 = 0;
	PDC7 = PWM_MAX;
	// B - NC
	PDC2 = 0;
	PDC8 = PWM_MAX;
	// C - NC
	PDC3 = 0;
	PDC9 = PWM_MAX;
}

void MotorShort(float p) {
	p *= PWM_MAX;

	PDC1 = 0;
	PDC7 = p;

	PDC2 = 0;
	PDC8 = p;

	PDC3 = 0;
	PDC9 = p;
}

void init_encoder_lut() {
	unsigned int i;
	for(i = 0; i < ENCODER_RES; i++) {
		encoder_LUT[i] = (double)i * 360.0/(double)ENCODER_RES;
	}
}

void interpolate_encoder_lut(double in[], unsigned int len) {
	int i, j, k;
	double delta;
	double arr[(int)pole_pairs*6][2];
	
	for(i = 0; i < len; i++) {
		arr[i][0] = in[i] * ENCODER_RES / 360.0;
		arr[i][1] = (double)i / len * ENCODER_RES;
	}
	
	for(i = 0; i < ENCODER_RES; i++) {
		for(j = 0; j < len; j++) {
			k = (j + 1) % len;
			if(i >= arr[j][0] && i < arr[k][0]) {
				delta = i - arr[j][0];
				delta = delta / (arr[k][0] - arr[j][0]) * ENCODER_RES / len;//(arr[k][1] - arr[j][1]);
				break;
			} else if((fabs(arr[k][0] - arr[j][0]) > ENCODER_RES/2) && (i > arr[j][0] || i < arr[k][0])) {
				delta = i - arr[j][0];
				if(delta > ENCODER_RES/2) {
					delta -= ENCODER_RES;
				} else if(delta < -ENCODER_RES/2) {
					delta += ENCODER_RES;
				}
				delta = delta / (arr[k][0] - arr[j][0] + ENCODER_RES) * ENCODER_RES / len;// * (arr[k][1] - arr[j][1]);
				break;
			}
		}
		encoder_LUT[i] = fmod(arr[j][1] + delta, ENCODER_RES) * 360.0 / ENCODER_RES;
	}
}
